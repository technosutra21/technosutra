<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Experiência imersiva em realidade aumentada dos 56 capítulos do Avatamsaka Sutra com modelos 3D interativos">
    <title>Techno Sutra AR - Experiência Imersiva em Realidade Aumentada</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="/js/app/TechnoSutraAR.js" as="script" type="module">
    <link rel="preload" href="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js" as="script">
    
    <!-- DNS prefetch for external resources -->
    <link rel="dns-prefetch" href="//ajax.googleapis.com">
    <link rel="dns-prefetch" href="//modelviewer.dev">
    
    <!-- Preconnect to CDN -->
    <link rel="preconnect" href="https://ajax.googleapis.com" crossorigin>
    
    <!-- Progressive Web App -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Techno Sutra AR">
    
    <!-- Open Graph meta tags -->
    <meta property="og:title" content="Techno Sutra AR - Avatamsaka Sutra em Realidade Aumentada">
    <meta property="og:description" content="Explore os 56 capítulos do Avatamsaka Sutra em modelos 3D interativos com realidade aumentada">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://technosutra.art">
    <meta property="og:image" content="/technosutra-logo.png">
    
    <!-- Twitter Card meta tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Techno Sutra AR">
    <meta name="twitter:description" content="Experiência imersiva em AR dos capítulos do Avatamsaka Sutra">
    <meta name="twitter:image" content="/technosutra-logo.png">
    
    <!-- Security headers -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://ajax.googleapis.com;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: blob:;
        media-src 'self' blob:;
        connect-src 'self' https:;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
        frame-ancestors 'none';
    ">
    
    <!-- Critical CSS inlined for performance -->
    <style>
        /* Critical above-the-fold styles */
        :root {
            --primary-color: #7877c6;
            --background-color: #000000;
            --text-color: #e5e7eb;
            --border-color: rgba(120, 119, 198, 0.1);
            --animation-duration: 0.3s;
            --animation-easing: cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: var(--background-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            position: relative;
            color: var(--text-color);
            font-display: swap;
        }
        
        /* Loading overlay - critical for first paint */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-title {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 300;
            margin-bottom: 1rem;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .loading-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 2rem;
            font-weight: 300;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hide content until loaded */
        .app-content {
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .app-content.loaded {
            opacity: 1;
        }

        /* Critical AR viewer styles */
        #camera-feed {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 1;
            background: var(--background-color);
        }
        
        model-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            --poster-color: transparent;
            background-color: transparent;
            z-index: 2;
            pointer-events: auto;
        }

        /* Skip navigation for accessibility */
        .skip-nav {
            position: absolute;
            top: -40px;
            left: 8px;
            z-index: 10001;
            background: var(--primary-color);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 600;
            transition: top 0.3s ease;
        }

        .skip-nav:focus {
            top: 8px;
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
    
    <!-- Load model-viewer library -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
</head>
<body>
    <!-- Skip navigation for accessibility -->
    <a href="#main-content" class="skip-nav">Pular para o conteúdo principal</a>

    <!-- Loading overlay -->
    <section class="loading-overlay" id="loading-overlay" aria-labelledby="loading-title">
        <div class="loading-content">
            <h1 class="loading-title" id="loading-title">Techno Sutra AR</h1>
            <div class="loading-subtitle">Preparando experiência imersiva...</div>
            <div class="loading-spinner" role="progressbar" aria-label="Carregando aplicação"></div>
        </div>
    </section>

    <!-- Main application content -->
    <main id="main-content" class="app-content">
        <!-- Live region for status announcements -->
        <div id="live-region" aria-live="polite" aria-atomic="true" class="sr-only"></div>

        <!-- Error 404 overlay -->
        <section class="error-404 hidden" id="error-404" role="alert" aria-labelledby="error-title">
            <div class="error-icon" aria-hidden="true">🤖</div>
            <h2 class="error-title" id="error-title">404</h2>
            <div class="error-message">Modelo não encontrado</div>
            <div class="error-subtitle">
                Redirecionando para o modelo padrão...
            </div>
        </section>

        <!-- Camera permission overlay -->
        <section class="camera-permission hidden" id="camera-permission" role="dialog" 
                 aria-labelledby="camera-title" aria-describedby="camera-description">
            <div class="camera-icon" aria-hidden="true">📷</div>
            <h2 class="camera-title" id="camera-title">Acesso à Câmera Necessário</h2>
            <div class="camera-description" id="camera-description">
                Para uma experiência AR completa, precisamos acessar sua câmera.
                Isso permite ver o mundo real como fundo para os modelos 3D.
            </div>
            <button class="camera-button" id="camera-button" aria-describedby="camera-description">
                Permitir Câmera
            </button>
        </section>

        <!-- Status messages -->
        <div id="status" class="hidden" role="status" aria-live="polite"></div>

        <!-- Camera feed for AR -->
        <video id="camera-feed" autoplay playsinline muted aria-label="Feed da câmera para realidade aumentada"></video>

        <!-- 3D Model Viewer Container -->
        <section id="modelViewer" aria-labelledby="model-section-title">
            <h2 id="model-section-title" class="sr-only">
                Visualizador de Modelo 3D em Realidade Aumentada
            </h2>
            <!-- ModelViewer component will be injected here -->
        </section>

        <!-- Model Controls -->
        <nav class="model-controls hidden" id="model-controls" role="toolbar" 
             aria-label="Controles do modelo 3D">
            <!-- Controls will be dynamically added -->
        </nav>
    </main>

    <!-- Application styles loaded non-critically -->
    <link rel="stylesheet" href="/css/app.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="/css/app.css"></noscript>

    <!-- Main application script - ES6+ module -->
    <script type="module">
        // Performance mark for measuring load time
        performance.mark('app-start');

        // Error boundary for unhandled errors
        window.addEventListener('error', (event) => {
            console.error('Unhandled error:', event.error);
            
            // Show user-friendly error message
            const errorElement = document.getElementById('status');
            if (errorElement) {
                errorElement.textContent = 'Erro inesperado. Recarregue a página.';
                errorElement.className = 'show error';
            }
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            event.preventDefault(); // Prevent default browser handling
        });

        // Load main application module
        import('./js/app/TechnoSutraAR.js')
            .then((module) => {
                // Application loaded successfully
                performance.mark('app-loaded');
                performance.measure('app-load-time', 'app-start', 'app-loaded');
                
                const loadTime = performance.getEntriesByName('app-load-time')[0]?.duration;
                if (loadTime) {
                    console.log(`🚀 Techno Sutra AR loaded in ${loadTime.toFixed(2)}ms`);
                }

                // Show main content
                const appContent = document.querySelector('.app-content');
                if (appContent) {
                    appContent.classList.add('loaded');
                }
            })
            .catch((error) => {
                console.error('❌ Failed to load application:', error);
                
                // Show fallback error message
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.innerHTML = `
                        <div class="loading-content">
                            <h1 class="loading-title">Erro de Carregamento</h1>
                            <div class="loading-subtitle">
                                Falha ao carregar a aplicação. Verifique sua conexão e recarregue a página.
                            </div>
                            <button onclick="location.reload()" style="
                                background: white;
                                color: #667eea;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 6px;
                                font-weight: 600;
                                cursor: pointer;
                                margin-top: 1rem;
                            ">
                                Recarregar Página
                            </button>
                        </div>
                    `;
                }
            });

        // Register service worker for offline functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw-modern.js');
                    console.log('✅ Service Worker registered:', registration.scope);
                } catch (error) {
                    console.warn('❌ Service Worker registration failed:', error);
                }
            });
        }

        // Add performance monitoring
        window.addEventListener('load', () => {
            // Report performance metrics
            const navigation = performance.getEntriesByType('navigation')[0];
            if (navigation) {
                console.log('📊 Performance Metrics:', {
                    'DOM Content Loaded': `${navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart}ms`,
                    'Load Complete': `${navigation.loadEventEnd - navigation.loadEventStart}ms`,
                    'Total Load Time': `${navigation.loadEventEnd - navigation.navigationStart}ms`,
                    'Time to First Byte': `${navigation.responseStart - navigation.navigationStart}ms`
                });
            }
        });
    </script>

    <!-- Structured data for SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Techno Sutra AR",
        "description": "Experiência imersiva em realidade aumentada dos 56 capítulos do Avatamsaka Sutra",
        "applicationCategory": "EducationalApplication",
        "operatingSystem": "Web Browser",
        "browserRequirements": "Requires WebXR or ARCore/ARKit support",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "author": {
            "@type": "Organization",
            "name": "Techno Sutra"
        }
    }
    </script>
</body>
</html>
