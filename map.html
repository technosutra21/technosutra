<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        }
        #map { width: 100%; height: 100%; }
        
        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
        }
        
        .trail-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 300px;
        }
        
        .maplibregl-popup {
            max-width: 300px;
        }
        
        .popup-content {
            padding: 8px;
        }
        
        .popup-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .popup-location {
            font-size: 11px;
            color: #666;
            font-style: italic;
        }
        
        .waypoint-marker {
            background: #7877c6;
            border: 2px solid white;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            cursor: pointer;
        }
        
        .user-marker {
            background: #ff4444;
            border: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
    <title>Mapa da Trilha Techno Sutra - √Åguas da Prata</title>
</head>
<body>
    <div id="map"></div>
    
    <!-- Controles personalizados -->
    <div class="map-controls">
        <button class="control-btn" onclick="toggleMapStyle()" id="styleBtn">üì° Sat√©lite</button>
        <button class="control-btn" onclick="zoomToTrail()">üó∫Ô∏è Ver Trilha</button>
        <button class="control-btn" onclick="locateUser()">üìç Minha Localiza√ß√£o</button>
        <button class="control-btn" onclick="toggleInfo()">‚ÑπÔ∏è Informa√ß√µes</button>
    </div>
    
    <!-- Informa√ß√µes da trilha -->
    <div class="trail-info" id="trailInfo">
        <div><strong>Trilha Techno Sutra</strong></div>
        <div>üìç √Åguas da Prata, SP</div>
        <div>üìä 56 waypoints ‚Ä¢ ~8km</div>
        <div>üß≠ Avatamsaka Sutra AR Experience</div>
    </div>
    
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <script>
        // Dados da trilha com informa√ß√µes do trail.json
        const trailData = {
            "1": { "lat": -21.868036707651, "lng": -46.67732383198648, "name": "Buda ≈öƒÅkyamuni", "location": "Jetavana, no parque de AnƒÅthapi·πá·∏çada em ≈örƒÅvastƒ´" },
            "2": { "lat": -21.86953296779599, "lng": -46.67805522448601, "name": "Samanta¬≠bhadra", "location": "Jetavana, no parque de AnƒÅthapi·πá·∏çada em ≈örƒÅvastƒ´" },
            "3": { "lat": -21.87091546996187, "lng": -46.67797426313243, "name": "Manjushri", "location": "DhanyƒÅkara e floresta sagrada de Vicitra sƒÅla dhvaja vy≈´ha" },
            "4": { "lat": -21.87221986659534, "lng": -46.67824132815174, "name": "Megha≈õrƒ´", "location": "Montanha Sugrƒ´va, na terra de RƒÅmƒÅvarƒÅnta" },
            "5": { "lat": -21.87309784586943, "lng": -46.67866035798463, "name": "SƒÅgara¬≠megha", "location": "Costa do oceano, distrito de SƒÅgaramukha" },
            "6": { "lat": -21.87393288759804, "lng": -46.67925395359822, "name": "Suprati·π£·π≠hita", "location": "SƒÅgaratƒ´ra, na regi√£o de La·πÖka" },
            "7": { "lat": -21.87514572152676, "lng": -46.67896578739468, "name": "Megha", "location": "Cidade de Vajrapura, na terra de Dravi·∏ça" },
            "8": { "lat": -21.87619736973498, "lng": -46.67855933883119, "name": "Muktaka", "location": "Cidade de VanavƒÅsƒ´" },
            "9": { "lat": -21.87646251203698, "lng": -46.67736879037174, "name": "SƒÅgara¬≠dhvaja", "location": "Milasphara·πáa, ponta do continente de Jambudvƒ´pa" },
            "10": { "lat": -21.87646009570215, "lng": -46.67623116961117, "name": "ƒÄ≈õƒÅ", "location": "Parque Samantavy≈´ha na cidade de SamudravetƒÅ·∏çƒ´" },
            "11": { "lat": -21.87726006988734, "lng": -46.6754990688399, "name": "Bhƒ´·π£mottara¬≠nirgho·π£a", "location": "Floresta na terra de NƒÅlayu" },
            "12": { "lat": -21.87881053413763, "lng": -46.67500319464728, "name": "Jayo·π£mƒÅyatana", "location": "Terra de ƒ™·π£ƒÅ·πáa, entre montanha de fogo e penhasco" },
            "13": { "lat": -21.88019054400148, "lng": -46.67496499173143, "name": "Maitraya·πáƒ´", "location": "Pal√°cio Vairocana-garbha na cidade de Si·πÉha-vij·πõmbhita" },
            "14": { "lat": -21.88187093491057, "lng": -46.67521163743071, "name": "Sudar≈õana", "location": "Densa floresta na terra de Trinayana" },
            "15": { "lat": -21.88360463284878, "lng": -46.67525319610547, "name": "Indriye≈õvara", "location": "Conflu√™ncia de rios na cidade de Sumukha" },
            "16": { "lat": -21.88554337763284, "lng": -46.67386659277159, "name": "Jayo·π£mƒÅyatana", "location": "Casa na cidade de Samudra-prati·π£·π≠hƒÅna" },
            "17": { "lat": -21.88804852246186, "lng": -46.67358940032627, "name": "VidvƒÅn", "location": "Encruzilhada no centro de MahƒÅsa·πÉbhava" },
            "18": { "lat": -21.89026427458782, "lng": -46.67236457977307, "name": "Sudar≈õana", "location": "Cidade de Si·πÉhapota, casa de dez andares" },
            "19": { "lat": -21.89257575982119, "lng": -46.67372402528618, "name": "Samanta¬≠netra", "location": "Loja de perfumes em Samantamukha, terra de Vetram≈´laka" },
            "20": { "lat": -21.89565884155847, "lng": -46.67312906215643, "name": "Anala", "location": "Cidade de TƒÅladhvaja, sala do trono" },
            "21": { "lat": -21.90046826241142, "lng": -46.67138193438598, "name": "MahƒÅprabha", "location": "Cidade de Suprabha, utopia de magnific√™ncia" },
            "22": { "lat": -21.90531978305068, "lng": -46.67251368039676, "name": "AcalƒÅ", "location": "Cidade de SthirƒÅ, casa dos pais" },
            "23": { "lat": -21.9089395994778, "lng": -46.67338258043213, "name": "Sarvagamin", "location": "Topo da colina Sulabha, perto de Tosala" },
            "24": { "lat": -21.91231515618248, "lng": -46.67015524085872, "name": "Utpalabh≈´ti", "location": "Terra de P·πõthurƒÅ·π£·π≠ra" },
            "25": { "lat": -21.91370861343965, "lng": -46.66815680928756, "name": "Vaira", "location": "Cidade costeira de K≈´·π≠ƒÅgƒÅra" },
            "26": { "lat": -21.91747796051475, "lng": -46.66700692393895, "name": "Jayottama", "location": "Floresta Vicitra Dhvaja, cidade de NandihƒÅra" },
            "27": { "lat": -21.92129874885887, "lng": -46.66574849523462, "name": "Si·πÉhavij·πõmbhitƒÅ", "location": "Parque S≈´rya Prabha, cidade de Kali·πÖgavana" },
            "28": { "lat": -21.92441500351332, "lng": -46.66505284033605, "name": "VasumitrƒÅ", "location": "Cidade de ≈öubhapara·πÉgama" },
            "29": { "lat": -21.92638215736361, "lng": -46.66537976269724, "name": "Ve·π£·π≠hila", "location": "Cidade de ≈öubhapƒÅra·πÉgama" },
            "30": { "lat": -21.92872573943014, "lng": -46.67003972230864, "name": "Avalokite≈õvara", "location": "Monte Potalaka, para√≠so terrestre" },
            "31": { "lat": -21.92801238471129, "lng": -46.67454405999145, "name": "AnanyagƒÅmin", "location": "Pico de montanha do sistema de mundos SahƒÅ" },
            "32": { "lat": -21.92645798923365, "lng": -46.67815322914891, "name": "MahƒÅdeva", "location": "Templo na encruzilhada da cidade de DvƒÅravatƒ´" },
            "33": { "lat": -21.92316358227298, "lng": -46.6791445469042, "name": "SthƒÅvarƒÅ", "location": "Bodhima·πá·∏ça na terra de Magadha" },
            "34": { "lat": -21.92362359048531, "lng": -46.6842726229277, "name": "VƒÅsantƒ´", "location": "C√©u acima da cidade de Kapilavastu" },
            "35": { "lat": -21.92525160262302, "lng": -46.6867179324565, "name": "Samanta¬≠gambhƒ´ra¬≠≈õrƒ´¬≠vimala¬≠prabhƒÅ", "location": "Bodhima·πá·∏ça, terra de Magadha, pr√≥ximo a VƒÅsantƒ´" },
            "36": { "lat": -21.9273497679517, "lng": -46.68749089829076, "name": "Pramudita¬≠nayana¬≠jagad¬≠virocanƒÅ", "location": "Bodhima·πá·∏ça, assembleia do Buda" },
            "37": { "lat": -21.9296471001546, "lng": -46.69039976309249, "name": "Samanta¬≠sattva¬≠trƒÅ·πáoja·∏•¬≠≈õrƒ´", "location": "No bodhima·πá·∏ça" },
            "38": { "lat": -21.92897397421807, "lng": -46.69217665332104, "name": "Pra≈õanta¬≠ruta¬≠sƒÅgara¬≠vatƒ´", "location": "No bodhima·πá·∏ça" },
            "39": { "lat": -21.93158183370527, "lng": -46.69375654414417, "name": "Sarva¬≠nagara¬≠rak·π£ƒÅ¬≠sa·πÉbhava¬≠teja·∏•¬≠≈õrƒ´", "location": "Trono de l√≥tus com s√©quito de deusas" },
            "40": { "lat": -21.93423405856974, "lng": -46.69338262520748, "name": "Sarva¬≠v·πõk·π£praphullana¬≠sukha¬≠sa·πÉvƒÅsƒÅ", "location": "K≈´·π≠ƒÅgƒÅra de √°rvores preciosas" },
            "41": { "lat": -21.93558462766117, "lng": -46.69382309551595, "name": "Sarva¬≠jagad¬≠rak·π£ƒÅ¬≠pra·πáidhƒÅna¬≠vƒ´rya¬≠prabhƒÅ", "location": "Bodhima·πá·∏ça, meio do s√©quito" },
            "42": { "lat": -21.93567267136837, "lng": -46.6939274554807, "name": "Sutejoma·πá·∏çala¬≠rati¬≠≈õrƒ´", "location": "Floresta de Lumbinƒ´, local de nascimento do Buda" },
            "43": { "lat": -21.93582378796983, "lng": -46.69400128111388, "name": "GopƒÅ", "location": "Sal√£o de assembleia dos bodhisattvas, Kapilavastu" },
            "44": { "lat": -21.945875, "lng": -46.72265833333334, "name": "MƒÅyƒÅdevƒ´", "location": "K≈´·π≠ƒÅgƒÅra miraculoso em grande l√≥tus de joias" },
            "45": { "lat": -21.94576185804032, "lng": -46.72279111267893, "name": "SurendrƒÅbhƒÅ", "location": "Para√≠so de TrƒÅyastri·πÉ≈õa (c√©u dos 33 deuses)" },
            "46": { "lat": -21.9458126872239, "lng": -46.72271692853997, "name": "Vi≈õvƒÅmitra", "location": "Cidade de Kapilavastu" },
            "47": { "lat": -21.94570944120324, "lng": -46.72285742172848, "name": "≈öilpƒÅbhij√±a", "location": "Ap√≥s falar com Vi≈õvƒÅmitra" },
            "48": { "lat": -21.94566634811362, "lng": -46.72291440447311, "name": "BhadrottamƒÅ", "location": "Cidade de Vartanaka, regi√£o de Kevalaka" },
            "49": { "lat": -21.94561390616393, "lng": -46.72297119284677, "name": "MuktƒÅsƒÅra", "location": "Cidade de Bharukaccha, regi√£o sul" },
            "50": { "lat": -21.9455701207428, "lng": -46.72301867573663, "name": "Sucandra", "location": "Floresta ao lado da cidade de Bharukaccha" },
            "51": { "lat": -21.94554168699781, "lng": -46.72306759875011, "name": "Ajitasena", "location": "Cidade de Roruka, regi√£o sul" },
            "52": { "lat": -21.94550541436743, "lng": -46.72312550616623, "name": "≈öivarƒÅgra", "location": "Vila chamada Dharma, regi√£o sul" },
            "53": { "lat": -21.94578734327873, "lng": -46.72274673868932, "name": "≈örƒ´sa·πÉbhava & ≈örƒ´mati", "location": "Cidade de SumanƒÅmukha, regi√£o sul" },
            "54": { "lat": -21.94585287592502, "lng": -46.72269285931593, "name": "Maitreya", "location": "Grande pavilh√£o Vairocana-vy≈´hƒÅla·πÉkƒÅra-garbha" },
            "55": { "lat": -21.9457395226932, "lng": -46.72281764935126, "name": "Manjushri", "location": "Cidade de SumanƒÅmukha, 110 yojanas de dist√¢ncia" },
            "56": { "lat": -21.9457395226932, "lng": -46.72281764935126, "name": "Samanta¬≠bhadra", "location": "Bodhima·πá·∏ça, diante do TathƒÅgata Vairocana" }
        };
        
        // Converter dados da trilha para array
        const waypoints = Object.entries(trailData).map(([id, point]) => ({
            id: parseInt(id),
            ...point
        }));
        
        // Estilos de mapa
        const mapStyles = {
            street: {
                name: 'OpenStreetMap',
                style: {
                    "version": 8,
                    "sources": {
                        "osm": {
                            "type": "raster",
                            "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
                            "tileSize": 256,
                            "attribution": "¬© OpenStreetMap contributors"
                        }
                    },
                    "layers": [{
                        "id": "osm",
                        "type": "raster",
                        "source": "osm"
                    }]
                }
            },
            satellite: {
                name: 'Sat√©lite',
                style: {
                    "version": 8,
                    "sources": {
                        "satellite": {
                            "type": "raster",
                            "tiles": ["https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}"],
                            "tileSize": 256,
                            "attribution": "¬© Google Satellite"
                        }
                    },
                    "layers": [{
                        "id": "satellite",
                        "type": "raster",
                        "source": "satellite"
                    }]
                }
            },
            hybrid: {
                name: 'H√≠brido',
                style: {
                    "version": 8,
                    "sources": {
                        "satellite": {
                            "type": "raster",
                            "tiles": ["https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}"],
                            "tileSize": 256,
                            "attribution": "¬© Google Hybrid"
                        }
                    },
                    "layers": [{
                        "id": "satellite",
                        "type": "raster",
                        "source": "satellite"
                    }]
                }
            }
        };
        
        let currentStyle = 'satellite';
        let userMarker = null;
        let watchId = null;
        
        // Configura√ß√µes de alta precis√£o para geolocaliza√ß√£o
        const highAccuracyOptions = {
            enableHighAccuracy: true,  // Usar GPS quando dispon√≠vel
            timeout: 20000,           // 20 segundos para obter posi√ß√£o inicial
            maximumAge: 0             // Sempre buscar nova posi√ß√£o, n√£o usar cache
        };
        
        const trackingOptions = {
            enableHighAccuracy: true,  // Manter GPS ativo para rastreamento
            timeout: 10000,           // 10 segundos para atualiza√ß√µes
            maximumAge: 5000          // Aceitar posi√ß√£o de at√© 5 segundos atr√°s
        };
        
        // Inicializar o mapa com vista sat√©lite
        const map = new maplibregl.Map({
            container: 'map',
            style: mapStyles.satellite.style,
            center: [-46.69, -21.91], // Centro aproximado da trilha
            zoom: 13,
            pitch: 0,
            bearing: 0
        });
        
        // Adicionar controles de navega√ß√£o
        map.addControl(new maplibregl.NavigationControl(), 'top-right');
        map.addControl(new maplibregl.ScaleControl(), 'bottom-right');
        
        // Fun√ß√µes de controle
        function toggleMapStyle() {
            const styleBtn = document.getElementById('styleBtn');
            const styles = Object.keys(mapStyles);
            const currentIndex = styles.indexOf(currentStyle);
            const nextIndex = (currentIndex + 1) % styles.length;
            currentStyle = styles[nextIndex];
            
            map.setStyle(mapStyles[currentStyle].style);
            
            const icons = { street: 'üó∫Ô∏è', satellite: 'üì°', hybrid: 'üåç' };
            styleBtn.innerHTML = `${icons[currentStyle]} ${mapStyles[currentStyle].name}`;
            
            // Re-adicionar as camadas ap√≥s mudan√ßa de estilo
            map.once('styledata', () => {
                addTrailLayers();
            });
        }
        
        function zoomToTrail() {
            const bounds = new maplibregl.LngLatBounds();
            waypoints.forEach(point => {
                bounds.extend([point.lng, point.lat]);
            });
            map.fitBounds(bounds, { padding: 50 });
        }
        
        function locateUser() {
            if (!navigator.geolocation) {
                alert('Geolocaliza√ß√£o n√£o √© suportada neste navegador.');
                return;
            }
            
            // Mostrar mensagem de carregamento
            const btn = document.querySelector('[onclick="locateUser()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'üîÑ Localizando...';
            btn.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLocation = [position.coords.longitude, position.coords.latitude];
                    const accuracy = position.coords.accuracy;
                    
                    console.log(`Localiza√ß√£o obtida com precis√£o de ${accuracy} metros`);
                    
                    // Remover marcador anterior se existir
                    if (userMarker) {
                        userMarker.remove();
                    }
                    
                    // Criar elemento customizado para o marcador do usu√°rio
                    const userMarkerEl = document.createElement('div');
                    userMarkerEl.className = 'user-marker';
                    
                    userMarker = new maplibregl.Marker(userMarkerEl)
                        .setLngLat(userLocation)
                        .setPopup(new maplibregl.Popup().setHTML(
                            `<div class="popup-content">
                                <div class="popup-title">üìç Voc√™ est√° aqui</div>
                                <div style="font-size: 10px; color: #666; margin-top: 4px;">
                                    Precis√£o: ~${Math.round(accuracy)}m
                                </div>
                            </div>`
                        ))
                        .addTo(map);
                    
                    map.flyTo({ center: userLocation, zoom: 17 });
                    
                    // Iniciar rastreamento cont√≠nuo
                    if (watchId) {
                        navigator.geolocation.clearWatch(watchId);
                    }
                    
                    watchId = navigator.geolocation.watchPosition(
                        (position) => {
                            const newLocation = [position.coords.longitude, position.coords.latitude];
                            if (userMarker) {
                                userMarker.setLngLat(newLocation);
                                
                                // Atualizar popup com nova precis√£o
                                const newAccuracy = position.coords.accuracy;
                                userMarker.setPopup(new maplibregl.Popup().setHTML(
                                    `<div class="popup-content">
                                        <div class="popup-title">üìç Voc√™ est√° aqui</div>
                                        <div style="font-size: 10px; color: #666; margin-top: 4px;">
                                            Precis√£o: ~${Math.round(newAccuracy)}m
                                        </div>
                                    </div>`
                                ));
                            }
                        },
                        (error) => {
                            console.warn('Erro no rastreamento:', error);
                            // Tentar novamente com configura√ß√µes menos restritivas se falhar
                            if (error.code === 3) { // TIMEOUT
                                navigator.geolocation.watchPosition(
                                    (position) => {
                                        const newLocation = [position.coords.longitude, position.coords.latitude];
                                        if (userMarker) {
                                            userMarker.setLngLat(newLocation);
                                        }
                                    },
                                    () => {}, // Silenciar erros subsequentes
                                    { enableHighAccuracy: false, maximumAge: 30000, timeout: 15000 }
                                );
                            }
                        },
                        trackingOptions
                    );
                    
                    // Restaurar bot√£o
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                },
                (error) => {
                    console.error('Erro de geolocaliza√ß√£o:', error);
                    let errorMessage = 'Erro ao obter localiza√ß√£o: ';
                    
                    switch(error.code) {
                        case 1: // PERMISSION_DENIED
                            errorMessage += 'Permiss√£o negada. Verifique as configura√ß√µes do navegador.';
                            break;
                        case 2: // POSITION_UNAVAILABLE
                            errorMessage += 'Posi√ß√£o indispon√≠vel. Tente novamente.';
                            break;
                        case 3: // TIMEOUT
                            errorMessage += 'Tempo esgotado. Tentando com menor precis√£o...';
                            // Tentar novamente com configura√ß√µes menos restritivas
                            navigator.geolocation.getCurrentPosition(
                                (position) => {
                                    const userLocation = [position.coords.longitude, position.coords.latitude];
                                    
                                    if (userMarker) {
                                        userMarker.remove();
                                    }
                                    
                                    const userMarkerEl = document.createElement('div');
                                    userMarkerEl.className = 'user-marker';
                                    
                                    userMarker = new maplibregl.Marker(userMarkerEl)
                                        .setLngLat(userLocation)
                                        .setPopup(new maplibregl.Popup().setHTML(
                                            '<div class="popup-content"><div class="popup-title">üìç Voc√™ est√° aqui (baixa precis√£o)</div></div>'
                                        ))
                                        .addTo(map);
                                    
                                    map.flyTo({ center: userLocation, zoom: 15 });
                                },
                                () => alert('N√£o foi poss√≠vel obter sua localiza√ß√£o.'),
                                { enableHighAccuracy: false, timeout: 15000, maximumAge: 300000 }
                            );
                            break;
                        default:
                            errorMessage += error.message;
                    }
                    
                    if (error.code !== 3) {
                        alert(errorMessage);
                    }
                    
                    // Restaurar bot√£o
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                },
                highAccuracyOptions
            );
        }
        
        function toggleInfo() {
            const info = document.getElementById('trailInfo');
            info.style.display = info.style.display === 'none' ? 'block' : 'none';
        }
        
        function addTrailLayers() {
            // Adicionar fonte da trilha
            if (!map.getSource('route')) {
                map.addSource('route', {
                    'type': 'geojson',
                    'data': {
                        'type': 'Feature',
                        'geometry': {
                            'type': 'LineString',
                            'coordinates': waypoints.map(point => [point.lng, point.lat])
                        }
                    }
                });
            }
            
            // Adicionar camada da trilha
            if (!map.getLayer('route')) {
                map.addLayer({
                    'id': 'route',
                    'type': 'line',
                    'source': 'route',
                    'layout': {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': '#7877c6',
                        'line-width': 4,
                        'line-opacity': 0.8
                    }
                });
            }
            
            // Adicionar camada de sombra da trilha
            if (!map.getLayer('route-shadow')) {
                map.addLayer({
                    'id': 'route-shadow',
                    'type': 'line',
                    'source': 'route',
                    'layout': {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': '#000000',
                        'line-width': 6,
                        'line-opacity': 0.3,
                        'line-translate': [1, 1]
                    }
                }, 'route');
            }
        }
        
        // Quando o mapa carregar
        map.on('load', () => {
            addTrailLayers();
            
            // Adicionar marcadores para cada waypoint
            waypoints.forEach((point, index) => {
                // Criar elemento customizado para o marcador
                const waypointEl = document.createElement('div');
                waypointEl.className = 'waypoint-marker';
                waypointEl.innerHTML = point.id;
                waypointEl.style.fontSize = '8px';
                waypointEl.style.color = 'white';
                waypointEl.style.fontWeight = 'bold';
                waypointEl.style.display = 'flex';
                waypointEl.style.alignItems = 'center';
                waypointEl.style.justifyContent = 'center';
                
                const popup = new maplibregl.Popup({ offset: 25 }).setHTML(
                    `<div class="popup-content">
                        <div class="popup-title">${point.id}. ${point.name}</div>
                        <div class="popup-location">${point.location}</div>
                        <div style="margin-top: 8px; font-size: 10px; color: #999;">
                            üìç ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}
                        </div>
                    </div>`
                );
                
                new maplibregl.Marker(waypointEl)
                    .setLngLat([point.lng, point.lat])
                    .setPopup(popup)
                    .addTo(map);
            });
            
            // Zoom inicial para mostrar toda a trilha
            zoomToTrail();
        });
        
        // Auto localizar usu√°rio ao carregar (opcional)
        setTimeout(() => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLocation = [position.coords.longitude, position.coords.latitude];
                        
                        const userMarkerEl = document.createElement('div');
                        userMarkerEl.className = 'user-marker';
                        
                        userMarker = new maplibregl.Marker(userMarkerEl)
                            .setLngLat(userLocation)
                            .setPopup(new maplibregl.Popup().setHTML(
                                '<div class="popup-content"><div class="popup-title">üìç Voc√™ est√° aqui</div></div>'
                            ))
                            .addTo(map);
                    },
                    () => {}, // Silenciar erros na localiza√ß√£o autom√°tica
                    { timeout: 5000 }
                );
            }
        }, 2000);
        
        // Cleanup ao sair da p√°gina
        window.addEventListener('beforeunload', () => {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        });
    </script>
</body>
</html>
