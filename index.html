<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description"
        content="Techno Sutra AR - Experiência imersiva em realidade aumentada dos 56 capítulos do Avatamsaka Sutra com modelos 3D interativos">
    <meta name="keywords"
        content="avatamsaka sutra, budismo, realidade aumentada, AR, modelos 3D, dharma, experiência imersiva, cyber dharma, techno sutra">
    <meta name="author" content="Techno Sutra Team">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Techno Sutra AR">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Techno Sutra AR - Cyber Dharma Experience">
    <meta property="og:description"
        content="Explore os 56 capítulos do Avatamsaka Sutra em realidade aumentada com modelos 3D interativos">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://technosutra.bhumisparshaschool.org/
    <meta property=" og:image" content="./icon.png">
    <meta property="og:site_name" content="Techno Sutra AR">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Techno Sutra AR - Cyber Dharma Experience">
    <meta name="twitter:description"
        content="Experiência imersiva em realidade aumentada dos 56 capítulos do Avatamsaka Sutra">
    <meta name="twitter:image" content="./icon.png">

    <title>Techno Sutra AR - Cyber Dharma Experience</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="shortcut icon" href="icon.png">

    <!-- Preconnections for performance -->
    <link rel="preconnect" href="https://ajax.googleapis.com" crossorigin>
    <link rel="dns-prefetch" href="https://modelviewer.dev">
    <link rel="preload"
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Chakra+Petch:wght@300;400;600;700&display=swap"
        as="style">
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Chakra+Petch:wght@300;400;600;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --neon-blue: #00ff95;
            --neon-pink: #ff0048;
            --neon-purple: #9d00ff;
            --cyber-dark: #000000;
            --font-main: 'Orbitron', sans-serif;
            --font-secondary: 'Chakra Petch', sans-serif;
            --glow-blue: 0 0 5px var(--neon-blue), 0 0 10px var(--neon-blue), 0 0 20px var(--neon-blue), 0 0 40px var(--neon-purple);
            --glow-pink: 0 0 5px var(--neon-pink), 0 0 10px var(--neon-pink), 0 0 20px var(--neon-pink), 0 0 40px var(--neon-purple);
        }

        html {
            height: 100%;
        }

        body {
            height: 100%;
            background-color: var(--cyber-dark);
            color: var(--neon-blue);
            font-family: var(--font-secondary);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            perspective: 1000px;
        }

        #vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: 0 0 200px rgba(0, 0, 0, 0.9) inset;
            z-index: 2;
            pointer-events: none;
        }

        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(1px 1px at 20px 30px, #eee, rgba(0, 0, 0, 0)),
                radial-gradient(1px 1px at 40px 70px, #fff, rgba(0, 0, 0, 0)),
                radial-gradient(1px 1px at 50px 160px, #ddd, rgba(0, 0, 0, 0)),
                radial-gradient(1px 1px at 90px 40px, #fff, rgba(0, 0, 0, 0)),
                radial-gradient(2px 2px at 150px 120px, #ddd, rgba(0, 0, 0, 0));
            background-repeat: repeat;
            background-size: 200px 200px;
            animation: zoom 15s infinite alternate ease-in-out;
            opacity: 0.5;
        }

        /* Dynamic canvas background */
        #dynamicBackgroundCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0;
            opacity: 0.6;
            pointer-events: none;
            z-index: 1;
        }

        /* Accessibility and reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .mandala-container {
                animation: none !important;
            }

            #starfield {
                animation: none !important;
            }

            .mandala-core {
                animation: pulse-reduced 8s infinite ease-in-out !important;
            }

            .item-content h3,
            .item-icon {
                animation: none !important;
            }

            @keyframes pulse-reduced {

                0%,
                100% {
                    transform: translate(-50%, -50%) scale(1);
                }

                50% {
                    transform: translate(-50%, -50%) scale(1.05);
                }
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --neon-blue: #00ffff;
                --neon-pink: #ff00ff;
                --neon-purple: #ff00ff;
            }

            .mandala-item {
                border-width: 2px;
                background: rgba(0, 0, 0, 0.9);
            }
        }

        /* Error fallback styles */
        .error-fallback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid #ff4444;
            color: #ff4444;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            z-index: 9999;
            display: none;
        }

        .canvas-fallback {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background:
                radial-gradient(circle at 20% 50%, rgba(0, 255, 149, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 30%, rgba(157, 0, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(0, 255, 149, 0.05) 0%, transparent 50%);
            z-index: 1;
            pointer-events: none;
            display: none;
        }


        @keyframes zoom {
            0% {
                transform: scale(1);
            }

            100% {
                transform: scale(1.2);
            }
        }

        .mandala-viewport {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2vh;
            box-sizing: border-box;
            animation: fadeIn 3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .mandala-container {
            position: absolute;
            width: 90vmin;
            height: 90vmin;
            transform-style: preserve-3d;
            animation: spin 120s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotateZ(0deg);
            }

            to {
                transform: rotateZ(360deg);
            }
        }

        @keyframes counter-spin {
            from {
                transform: rotateZ(0deg);
            }

            to {
                transform: rotateZ(-360deg);
            }
        }

        @keyframes counter-spin-centered {
            from {
                transform: translate(-50%, -50%) rotateZ(0deg);
            }

            to {
                transform: translate(-50%, -50%) rotateZ(-360deg);
            }
        }

        .mandala-core {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 15vmin;
            height: 15vmin;
            transform: translate(-50%, -50%);
            border-radius: 80%;
            background: radial-gradient(circle, var(--neon-purple) 10%, rgba(0, 0, 0, 0) 70%);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--glow-pink);
            animation: pulse 4s infinite ease-in-out;
        }

        .core-icon {
            width: 20vmin;
            height: 20vmin;
            object-fit: contain;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
                box-shadow: var(--glow-pink);
            }

            50% {
                transform: translate(-50%, -50%) scale(1.1);
                box-shadow: 0 0 200px var(--neon-pink), 0 0 200px var(--neon-pink), 0 0 400px var(--neon-pink), 0 0 800px var(--neon-blue);
            }
        }

        .mandala-item {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 28vmin;
            height: 28vmin;
            margin-left: -14vmin;
            margin-top: -14vmin;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--neon-blue);
            box-shadow: 0 0 15px var(--neon-blue), 0 0 30px var(--neon-blue), 0 0 60px var(--neon-blue), 0 0 100px var(--neon-purple);
            backdrop-filter: blur(5px);
            color: var(--neon-blue);
            text-decoration: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.5s ease, box-shadow 0.5s ease;
            transform-origin: center;
            z-index: 10;
        }

        .mandala-item:hover {
            box-shadow: 0 0 250px var(--neon-blue), 0 0 50px var(--neon-blue), 0 0 100px var(--neon-blue), 0 0 10px var(--neon-purple);
            z-index: 11;
        }

        .item-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: 15vmin;
            opacity: 0.2;
            z-index: 1;
            transform-origin: center;
            animation: counter-spin-centered 120s linear infinite;
        }

        .item-content {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            z-index: 2;
        }

        .item-content h3 {
            font-family: var(--font-main);
            font-size: 2.5vmin;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: white;
            text-shadow: 0 0 5px white;
            text-align: center;
            line-height: 1.2;
            margin: 0;
            padding: 0 1vmin;
            animation: counter-spin 120s linear infinite;
        }

        .item-content p {
            font-size: 1.5vmin;
            padding: 0 2vmin;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
        }

        .title-container {
            position: absolute;
            bottom: 2vh;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5;
            pointer-events: none;
        }

        .main-title {
            font-family: var(--font-main);
            font-weight: 900;
            font-size: 5vmin;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            position: relative;
            text-shadow: var(--glow-blue);
        }

        .main-title::before,
        .main-title::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .main-title::before {
            left: 2px;
            text-shadow: -1px 0 var(--neon-pink);
            clip: rect(24px, 550px, 90px, 0);
            animation: glitch-anim-1 2s infinite linear alternate-reverse;
        }

        .main-title::after {
            left: -2px;
            text-shadow: -1px 0 var(--neon-blue), 1px 1px var(--neon-green);
            clip: rect(85px, 550px, 140px, 0);
            animation: glitch-anim-2 3s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim-1 {
            0% {
                clip: rect(42px, 9999px, 44px, 0);
            }

            20% {
                clip: rect(12px, 9999px, 89px, 0);
            }

            40% {
                clip: rect(45px, 9999px, 89px, 0);
            }

            60% {
                clip: rect(13px, 9999px, 54px, 0);
            }

            80% {
                clip: rect(62px, 9999px, 83px, 0);
            }

            100% {
                clip: rect(4px, 9999px, 78px, 0);
            }
        }

        @keyframes glitch-anim-2 {
            0% {
                clip: rect(22px, 9999px, 90px, 0);
            }

            20% {
                clip: rect(33px, 9999px, 4px, 0);
            }

            40% {
                clip: rect(13px, 9999px, 44px, 0);
            }

            60% {
                clip: rect(52px, 9999px, 83px, 0);
            }

            80% {
                clip: rect(12px, 9999px, 54px, 0);
            }

            100% {
                clip: rect(72px, 9999px, 8px, 0);
            }
        }

        .subtitle {
            font-size: 2vmin;
            color: var(--neon-pink);
            text-shadow: 0 0 10px var(--neon-pink);
            letter-spacing: 0.1em;
        }

        .top-controls {
            position: fixed;
            top: 1vh;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
            z-index: 100;
            align-items: center;
        }

        .control-btn {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--neon-blue);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            font-family: var(--font-secondary);
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            min-width: 80px;
        }

        .control-btn .icon {
            font-size: 1.5em;
        }

        .control-btn .text {
            font-size: 0.9em;
            font-weight: 600;
        }


        .qr-btn {
            border-color: var(--neon-blue);
        }

        .qr-btn:hover {
            background: rgba(0, 255, 149, 0.2);
            box-shadow: 0 0 20px var(--neon-blue);
            transform: translateY(-2px);
        }

        /* QR Modal Styles */
        .qr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .qr-modal-content {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid var(--neon-blue);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 50px var(--neon-blue);
        }

        .qr-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .qr-modal-header h3 {
            color: var(--neon-blue);
            font-family: var(--font-main);
            margin: 0;
            font-size: 1.5rem;
        }

        .qr-close-btn {
            background: none;
            border: none;
            color: var(--neon-pink);
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .qr-close-btn:hover {
            background: rgba(255, 0, 72, 0.2);
            box-shadow: 0 0 15px var(--neon-pink);
        }

        .qr-scanner-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .qr-video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid var(--neon-blue);
        }

        .qr-scanner-overlay {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 400px;
            height: 300px;
            pointer-events: none;
        }

        .qr-scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid var(--neon-pink);
            border-radius: 12px;
            background: transparent;
            box-shadow: 0 0 20px var(--neon-pink);
            animation: pulse 2s infinite;
        }

        .qr-instruction {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--neon-blue);
            font-family: var(--font-secondary);
            margin: 0;
            text-shadow: 0 0 10px var(--neon-blue);
        }

        .qr-manual-input {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
        }

        .qr-manual-input input {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--neon-blue);
            color: white;
            padding: 0.75rem;
            border-radius: 6px;
            font-family: var(--font-secondary);
            width: 200px;
        }

        .qr-manual-input input:focus {
            outline: none;
            box-shadow: 0 0 10px var(--neon-blue);
        }

        .qr-manual-input button {
            background: rgba(0, 255, 149, 0.2);
            border: 1px solid var(--neon-blue);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: var(--font-secondary);
            transition: all 0.3s ease;
        }

        .qr-manual-input button:hover {
            background: rgba(0, 255, 149, 0.4);
            box-shadow: 0 0 15px var(--neon-blue);
        }

        .fade-out {
            animation: fadeOut 0.5s forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: scale(0.95);
            }
        }

        /* Responsive Design Improvements */
        @media (max-width: 768px) {
            .mandala-container {
                width: 95vmin;
                height: 95vmin;
            }

            .mandala-item {
                width: 25vmin;
                height: 25vmin;
                margin-left: -12.5vmin;
                margin-top: -12.5vmin;
            }

            .item-icon {
                font-size: 12vmin;
            }

            .item-content h3 {
                font-size: 2.2vmin;
            }

            .item-content p {
                font-size: 1.3vmin;
                padding: 0 1.5vmin;
            }

            .main-title {
                font-size: 4.5vmin;
            }

            .subtitle {
                font-size: 1.8vmin;
            }

            .top-controls {
                top: 1vh;
                gap: 0.5rem;
            }

            .control-btn {
                padding: 0.8rem 1rem;
                font-size: 12px;
                min-width: 100px;
            }

            .control-btn .icon {
                font-size: 1.3em;
            }

            .control-btn .text {
                font-size: 0.8em;
            }

            .qr-modal-content {
                padding: 1.5rem;
                width: 95%;
            }

            .qr-video {
                height: 250px;
            }

            .qr-scanner-overlay {
                height: 250px;
            }

            .qr-scanner-frame {
                width: 150px;
                height: 150px;
            }
        }

        @media (max-width: 480px) {
            .mandala-viewport {
                padding: 1vh;
            }

            .mandala-item {
                width: 22vmin;
                height: 22vmin;
                margin-left: -11vmin;
                margin-top: -11vmin;
            }

            .item-icon {
                font-size: 10vmin;
            }

            .item-content h3 {
                font-size: 2vmin;
            }

            .item-content p {
                font-size: 1.2vmin;
                padding: 0 1vmin;
            }

            .main-title {
                font-size: 4vmin;
                letter-spacing: 0.1em;
            }

            .subtitle {
                font-size: 1.6vmin;
            }

            .top-controls {
                flex-direction: column;
                gap: 0.5rem;
            }

            .control-btn {
                padding: 0.7rem;
                font-size: 11px;
                min-width: 90px;
            }

            .qr-modal-content {
                padding: 1rem;
            }

            .qr-video {
                height: 200px;
            }

            .qr-scanner-overlay {
                height: 200px;
            }

            .qr-scanner-frame {
                width: 120px;
                height: 120px;
            }

            .qr-manual-input {
                flex-direction: column;
                gap: 0.5rem;
            }

            .qr-manual-input input {
                width: 100%;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .mandala-item {
                border-width: 2px;
                background: rgba(0, 0, 0, 0.8);
            }

            .item-content h3,
            .item-content p {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            }
        }

        /* Reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            .mandala-container {
                animation: none;
            }

            .mandala-core {
                animation: none;
            }

            #starfield {
                animation: none;
            }

            .main-title::before,
            .main-title::after {
                animation: none;
            }

            .item-content h3,
            .item-icon {
                animation: none;
            }
        }

        /* Focus styles for accessibility */
        .mandala-item:focus {
            outline: 3px solid var(--neon-blue);
            outline-offset: 2px;
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--neon-blue);
        }

        .control-btn:focus {
            outline: 2px solid var(--neon-blue);
            outline-offset: 2px;
        }

        /* Notification animations */
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* Print styles */
        @media print {

            #starfield,
            #vignette,
            .install-btn {
                display: none;
            }

            body {
                background: white;
                color: black;
            }

            .main-title,
            .subtitle {
                color: black;
                text-shadow: none;
            }
        }

        /* Popup Styles */
        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .popup-content {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid var(--neon-blue);
            border-radius: 12px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 50px var(--neon-blue);
            animation: slideDown 0.5s ease-out;
        }

        .popup h2 {
            color: var(--neon-blue);
            font-family: var(--font-main);
            margin: 0 0 1rem 0;
            font-size: 1.8rem;
        }

        .popup p {
            color: rgba(255, 255, 255, 0.8);
            margin: 0 0 1rem 0;
            font-size: 1rem;
            line-height: 1.4;
        }

        .popup ul {
            list-style: none;
            padding: 0;
            margin: 0 0 1rem 0;
            text-align: left;
        }

        .popup li {
            color: rgba(255, 255, 255, 0.9);
            margin: 0.5rem 0;
            position: relative;
            padding-left: 1.2rem;
        }

        .popup li:before {
            content: '✔️';
            position: absolute;
            left: 0;
            top: 0;
            font-size: 1.2rem;
            line-height: 1;
            color: var(--neon-pink);
        }

        .popup button {
            background: var(--neon-blue);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: var(--font-secondary);
            font-size: 1rem;
            transition: background 0.3s ease;
            margin-top: 1rem;
        }

        .popup button:hover {
            background: var(--neon-purple);
        }
    </style>
</head>

<body>
    <!-- Error fallback elements -->
    <div class="error-fallback" id="errorFallback">
        <h3>🛠️ Technical Difficulty</h3>
        <p>Some visual effects are unavailable. The experience will continue with basic graphics.</p>
        <button onclick="document.getElementById('errorFallback').style.display='none'">Continue</button>
    </div>

    <div class="canvas-fallback" id="canvasFallback"></div>

    <div id="starfield"></div>
    <div id="vignette"></div>
    <canvas id="dynamicBackgroundCanvas"></canvas>

    <main class="mandala-viewport" id="viewport">
        <div class="mandala-container" id="mandalaContainer">
            <a href="http://bhumisparshaschool.org/techno-sutra" class="mandala-core" target="_blank"
                rel="noopener noreferrer" aria-label="Visit Techno Sutra at Bhumisparsha School">
                <img src="icon.png" alt="Techno Sutra Logo" class="core-icon">
            </a>

            <a href="home.html" class="mandala-item" data-title="Home" data-index="0" role="button" tabindex="0"
                aria-label="TECHNOSUTRA">
                <div class="item-icon" aria-hidden="true">⁛</div>
                <div class="item-content">
                    <h3>TECHNOSUTRA</br>HOME</h3>
                </div>
            </a>

            <a href="galeria.html" class="mandala-item" data-title="Gallery" data-index="1" role="button" tabindex="0"
                aria-label="Galeria 3D - Explore os 56 capítulos do Avatamsaka Sutra">
                <div class="item-icon" aria-hidden="true">⁜</div>
                <div class="item-content">
                    <h3>Galeria</br> 3D</h3>
                </div>
            </a>

            <a href="map.html" class="mandala-item" data-title="Map" data-index="2" role="button" tabindex="0"
                aria-label="Mapa Interativo - Navegue pelo caminho do dharma virtual">
                <div class="item-icon" aria-hidden="true">⁕</div>
                <div class="item-content">
                    <h3>Mapa Interativo</h3>
                </div>
            </a>
        </div>
        <div class="title-container">
            <h1 class="main-title" data-text="Techno Sutra">Techno Sutra</h1>
            <h2 class="subtitle">Bless This Cyberspace</h2>
        </div>
    </main>

    <!-- Top Control Panel -->
    <div class="top-controls">
        <button id="qrReaderBtn" class="control-btn qr-btn">
            <span class="icon">📷</span>
            <span class="text">QR Scanner</span>
        </button>
    </div>

    <!-- QR Code Reader Modal -->
    <div id="qrModal" class="qr-modal" style="display: none;">
        <div class="qr-modal-content">
            <div class="qr-modal-header">
                <h3>QR Code Scanner</h3>
                <button id="closeQrModal" class="qr-close-btn">×</button>
            </div>
            <div class="qr-scanner-container">
                <video id="qrVideo" class="qr-video" playsinline></video>
                <div class="qr-scanner-overlay">
                    <div class="qr-scanner-frame"></div>
                    <p class="qr-instruction">Point camera at QR code</p>
                </div>
            </div>
            <div class="qr-manual-input">
                <input type="number" id="manualModelInput" placeholder="Or enter model number (1-56)" min="1" max="56">
                <button id="manualModelBtn">Go to Model</button>
            </div>
        </div>
    </div>

    <!-- Offline Installation Instructions Popup -->
    <div id="offlinePopup" class="popup" style="display: none;">
        <div class="popup-content">
            <h2>Install Techno Sutra AR</h2>
            <p>To use this site offline, follow the instructions below based on your browser:</p>
            <ul>
                <li><strong>iOS Safari:</strong> Tap <em>Share</em> and then <em>Add to Home Screen</em>.</li>
                <li><strong>Android Chrome:</strong> Tap the <em>three dots</em> menu and select <em>Install App</em>.</li>
                <li><strong>Desktop Chrome:</strong> Click the <em>Install</em> button in the browser's address bar.</li>
            </ul>
            <button id="closePopup">Got it!</button>
        </div>
    </div>

    <script>
        // Enhanced error handling
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
        });

        // Check for model parameter and redirect to AR.html if present
        function checkModelParameter() {
            const urlParams = new URLSearchParams(window.location.search);
            const modelParam = urlParams.get('model');

            if (modelParam) {
                const modelId = parseInt(modelParam);
                // Validate model ID is within valid range (1-56)
                if (modelId >= 1 && modelId <= 56) {
                    console.log(`Redirecting to AR.html with model ${modelId}`);
                    // Add fade out effect before redirect
                    document.body.classList.add('fade-out');
                    setTimeout(() => {
                        window.location.href = `AR.html?model=${modelId}`;
                    }, 500);
                    return true; // Indicates redirect is happening
                } else {
                    console.warn(`Invalid model ID: ${modelId}. Must be between 1-56.`);
                    // Remove invalid parameter from URL
                    urlParams.delete('model');
                    const newUrl = window.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
                    window.history.replaceState({}, '', newUrl);
                }
            }
            return false; // No redirect
        }



        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Check for model parameter first
                if (checkModelParameter()) {
                    return; // Stop initialization if redirecting
                }

                const mandalaContainer = document.getElementById('mandalaContainer');
                const items = document.querySelectorAll('.mandala-item');
                const viewport = document.getElementById('viewport');

                if (!mandalaContainer || !items.length || !viewport) {
                    throw new Error('Required DOM elements not found');
                }

                const numItems = items.length;
                const radius = 35; // in vmin

                items.forEach((item, i) => {
                    try {
                        const angle = (i / numItems) * 360;
                        const x = Math.cos(angle * Math.PI / 180) * radius;
                        const y = Math.sin(angle * Math.PI / 180) * radius;

                        // We use vmin for positioning, which is CSS-only, but JS can also do it:
                        item.style.transform = `rotate(${angle}deg) translate(${radius}vmin) rotate(${-angle}deg)`;

                        // Mouse event handlers
                        item.addEventListener('mouseenter', () => {
                            if (mandalaContainer) {
                                mandalaContainer.style.animationPlayState = 'paused';
                            }
                        });

                        item.addEventListener('mouseleave', () => {
                            if (mandalaContainer) {
                                mandalaContainer.style.animationPlayState = 'running';
                            }
                        });

                        // Enhanced click handler with error handling
                        const handleNavigation = (e) => {
                            try {
                                e.preventDefault();
                                const href = item.getAttribute('href');
                                if (href) {
                                    document.body.classList.add('fade-out');
                                    setTimeout(() => {
                                        window.location.href = href;
                                    }, 500);
                                }
                            } catch (error) {
                                console.error('Navigation error:', error);
                                // Fallback navigation
                                window.location.href = item.href;
                            }
                        };

                        item.addEventListener('click', handleNavigation);

                        // Keyboard navigation support
                        item.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                handleNavigation(e);
                            }
                        });

                        // Focus and blur events for accessibility
                        item.addEventListener('focus', () => {
                            if (mandalaContainer) {
                                mandalaContainer.style.animationPlayState = 'paused';
                            }
                        });

                        item.addEventListener('blur', () => {
                            if (mandalaContainer) {
                                mandalaContainer.style.animationPlayState = 'running';
                            }
                        });

                    } catch (error) {
                        console.error(`Error setting up item ${i}:`, error);
                    }
                });

                // Enhanced parallax effect with error handling
                if (viewport && mandalaContainer) {
                    viewport.addEventListener('mousemove', (e) => {
                        try {
                            const { clientX, clientY, currentTarget } = e;
                            const { clientWidth, clientHeight } = currentTarget;
                            const x = (clientX - clientWidth / 2) / clientWidth;
                            const y = (clientY - clientHeight / 2) / clientHeight;

                            // Throttle the animation for better performance
                            requestAnimationFrame(() => {
                                if (mandalaContainer) {
                                    mandalaContainer.style.transform = `rotateX(${-y * 10}deg) rotateY(${x * 10}deg)`;
                                }
                            });
                        } catch (error) {
                            console.error('Parallax error:', error);
                        }
                    });
                }

                // Enhanced PWA Installation Logic
                let deferredPrompt;
                let isAppInstalled = false;
                const installButton = document.getElementById('installPWA');

                // Check if app is already installed
                function checkIfAppInstalled() {
                    // Method 1: Check if running in standalone mode
                    if (window.matchMedia('(display-mode: standalone)').matches) {
                        return true;
                    }

                    // Method 2: Check if running as PWA on iOS
                    if (window.navigator.standalone === true) {
                        return true;
                    }

                    // Method 3: Check for PWA-specific user agent
                    if (document.referrer.includes('android-app://')) {
                        return true;
                    }

                    return false;
                }

                // Update button appearance based on install status
                function updateInstallButton() {
                    if (!installButton) return;

                    if (isAppInstalled) {
                        // App is installed - show with low opacity
                        installButton.classList.add('installed');
                        installButton.innerHTML = `
                            <span class="icon">✅</span>
                            <span class="text">App Instalado</span>
                        `;
                        installButton.title = 'App já está instalado e disponível offline';
                        console.log('PWA detected as installed - showing with low opacity');
                    } else {
                        // App is not installed - show normally
                        installButton.classList.remove('installed');
                        installButton.innerHTML = `
                            <span class="icon">💾</span>
                            <span class="text">Install Offline App</span>
                        `;
                        installButton.title = 'Instalar app para uso offline completo';
                        console.log('PWA not installed - showing install button');
                    }
                }

                // Initialize PWA installation logic
                function initializePWA() {
                    if (!installButton) return;

                    // Check initial install status
                    isAppInstalled = checkIfAppInstalled();
                    updateInstallButton();

                    // Listen for beforeinstallprompt event
                    window.addEventListener('beforeinstallprompt', (e) => {
                        try {
                            e.preventDefault();
                            deferredPrompt = e;
                            isAppInstalled = false;
                            updateInstallButton();
                            console.log('PWA install prompt available');
                        } catch (error) {
                            console.error('PWA prompt error:', error);
                        }
                    });

                    // Handle install button click
                    installButton.addEventListener('click', async () => {
                        try {
                            if (isAppInstalled) {
                                // App is already installed - show notification
                                showNotification(
                                    '✅ App Já Instalado',
                                    'O Techno Sutra AR já está instalado e funcionando offline!',
                                    'info',
                                    4000
                                );
                                return;
                            }

                            if (deferredPrompt) {
                                // Show install prompt
                                await deferredPrompt.prompt();
                                const { outcome } = await deferredPrompt.userChoice;

                                if (outcome === 'accepted') {
                                    console.log('User accepted the A2HS prompt');
                                    isAppInstalled = true;
                                    updateInstallButton();

                                    // Trigger complete offline caching after installation
                                    setTimeout(() => {
                                        triggerCompleteOfflineCaching();
                                    }, 2000);

                                    showNotification(
                                        '🎉 App Instalado!',
                                        'Preparando conteúdo para uso offline...',
                                        'success',
                                        5000
                                    );
                                } else {
                                    console.log('User dismissed the A2HS prompt');
                                }
                                deferredPrompt = null;
                            } else {
                                // No prompt available - trigger manual caching
                                showNotification(
                                    '📦 Preparando Offline',
                                    'Baixando conteúdo para uso offline...',
                                    'info',
                                    3000
                                );
                                triggerCompleteOfflineCaching();
                            }
                        } catch (error) {
                            console.error('PWA installation error:', error);
                            showNotification(
                                '⚠️ Erro na Instalação',
                                'Não foi possível instalar o app. Tente novamente.',
                                'error',
                                4000
                            );
                        }
                    });

                    // Listen for successful installation
                    window.addEventListener('appinstalled', () => {
                        try {
                            isAppInstalled = true;
                            updateInstallButton();
                            console.log('PWA was installed successfully');

                            showNotification(
                                '🎉 Instalação Completa!',
                                'App instalado com sucesso. Preparando para uso offline...',
                                'success',
                                4000
                            );
                        } catch (error) {
                            console.error('PWA installed event error:', error);
                        }
                    });

                    // Monitor display mode changes
                    if ('matchMedia' in window) {
                        const displayModeQuery = window.matchMedia('(display-mode: standalone)');
                        displayModeQuery.addListener((e) => {
                            isAppInstalled = e.matches;
                            updateInstallButton();
                            console.log(`Display mode changed: ${e.matches ? 'standalone' : 'browser'}`);
                        });
                    }

                    // Periodic check for install status (useful for edge cases)
                    setInterval(() => {
                        const wasInstalled = isAppInstalled;
                        isAppInstalled = checkIfAppInstalled();
                        if (wasInstalled !== isAppInstalled) {
                            updateInstallButton();
                            console.log(`Install status changed: ${isAppInstalled ? 'installed' : 'not installed'}`);
                        }
                    }, 5000); // Check every 5 seconds
                }

                // Initialize PWA when DOM is ready
                if (installButton) {
                    initializePWA();
                }



                // QR Code Scanner Setup
                if (qrReaderBtn) {
                    qrReaderBtn.addEventListener('click', openQRScanner);
                }

                if (closeQrModal) {
                    closeQrModal.addEventListener('click', closeQRScanner);
                }

                if (qrModal) {
                    qrModal.addEventListener('click', (e) => {
                        if (e.target === qrModal) {
                            closeQRScanner();
                        }
                    });
                }

                if (manualModelBtn) {
                    manualModelBtn.addEventListener('click', () => {
                        const modelNum = parseInt(manualModelInput.value);
                        if (modelNum >= 1 && modelNum <= 56) {
                            redirectToModel(modelNum);
                        } else {
                            alert('Please enter a valid model number (1-56)');
                        }
                    });
                }

                if (manualModelInput) {
                    manualModelInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            manualModelBtn.click();
                        }
                    });
                }

                initializeParticleBackground();
                
                function initializeParticleBackground() {
                    const canvas = document.getElementById('dynamicBackgroundCanvas');
                    if (!canvas) return;
                    
                    const ctx = canvas.getContext('2d');
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                    
                    let animationId;
                    
                    function animate() {
                        if (!window.RotatingSmallerSphereSort) {
                            animationId = requestAnimationFrame(animate);
                            return;
                        }
                        
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        
                        const particles = window.RotatingSmallerSphereSort(50, Date.now(), window.animationController);
                        
                        particles.forEach(particle => {
                            ctx.save();
                            ctx.globalAlpha = particle.alpha * 0.6;
                            ctx.fillStyle = `hsl(${particle.hue}, 70%, 60%)`;
                            ctx.beginPath();
                            ctx.arc(
                                (particle.x / 50) * canvas.width,
                                (particle.y / 50) * canvas.height,
                                particle.size,
                                0,
                                Math.PI * 2
                            );
                            ctx.fill();
                            ctx.restore();
                        });
                        
                        animationId = requestAnimationFrame(animate);
                    }
                    
                    animate();
                    
                    window.addEventListener('resize', () => {
                        canvas.width = window.innerWidth;
                        canvas.height = window.innerHeight;
                    });
                }


            } catch (error) {
                console.error('Main initialization error:', error);
            }
        });

        // QR Scanner Functions
        async function openQRScanner() {
            try {
                qrModal.style.display = 'flex';

                // Request camera permission
                qrStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 400 },
                        height: { ideal: 300 }
                    }
                });

                qrVideo.srcObject = qrStream;
                qrVideo.play();

                // Start QR code detection
                startQRDetection();

            } catch (error) {
                console.error('Camera access error:', error);
                alert('Camera access denied. You can still enter the model number manually.');
            }
        }

        function closeQRScanner() {
            qrModal.style.display = 'none';

            if (qrStream) {
                qrStream.getTracks().forEach(track => track.stop());
                qrStream = null;
            }
        }

        function startQRDetection() {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            function scanFrame() {
                if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA && qrModal.style.display === 'flex') {
                    canvas.width = qrVideo.videoWidth;
                    canvas.height = qrVideo.videoHeight;
                    context.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);

                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);

                    // Simple QR detection using manual URL parsing
                    // This is a simplified approach - in production you'd use a proper QR library
                    try {
                        // For demo purposes, we'll rely on manual input
                        // In production, integrate with a QR code library like jsQR
                        setTimeout(scanFrame, 500);
                    } catch (error) {
                        setTimeout(scanFrame, 500);
                    }
                } else if (qrModal.style.display === 'flex') {
                    setTimeout(scanFrame, 100);
                }
            }

            scanFrame();
        }

        function redirectToModel(modelNum) {
            console.log(`Redirecting to model ${modelNum}`);
            closeQRScanner();

            // Add fade out effect
            document.body.classList.add('fade-out');
            setTimeout(() => {
                window.location.href = `AR.html?model=${modelNum}`;
            }, 500);
        }

        // Enhanced PWA Installation with Complete Offline Caching
        function triggerCompleteOfflineCaching() {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                console.log('🚀 Triggering complete offline caching for PWA...');

                // Show loading notification
                showNotification('📦 Preparing Offline Content', 'Downloading all models and pages for offline use...', 'info', 0);

                // Send message to service worker
                const messageChannel = new MessageChannel();

                messageChannel.port1.onmessage = (event) => {
                    const { type, success, message } = event.data;
                    if (type === 'COMPLETE_CACHE_FINISHED') {
                        hideNotification();
                        showNotification(
                            success ? '✅ App Ready Offline!' : '⚠️ Partial Offline Setup',
                            message || (success ? 'All content cached successfully!' : 'Some content failed to cache'),
                            success ? 'success' : 'warning',
                            6000
                        );
                    }
                };

                navigator.serviceWorker.controller.postMessage({
                    type: 'FORCE_COMPLETE_CACHE'
                }, [messageChannel.port2]);
            }
        }

        let currentNotification = null;

        function showNotification(title, message, type = 'info', duration = 5000) {
            // Remove existing notification
            if (currentNotification) {
                currentNotification.remove();
            }

            // Create notification
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <strong>${title}</strong>
                    <p>${message}</p>
                </div>
            `;

            // Styles
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.95);
                color: white;
                border: 2px solid ${getNotificationColor(type)};
                border-radius: 8px;
                padding: 1rem;
                z-index: 1001;
                max-width: 400px;
                text-align: center;
                backdrop-filter: blur(10px);
                box-shadow: 0 0 30px ${getNotificationColor(type)};
                animation: slideDown 0.3s ease-out;
            `;

            document.body.appendChild(notification);
            currentNotification = notification;

            if (duration > 0) {
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.style.animation = 'slideDown 0.3s ease-out reverse';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, duration);
            }
        }

        function hideNotification() {
            if (currentNotification) {
                currentNotification.remove();
                currentNotification = null;
            }
        }

        function getNotificationColor(type) {
            const colors = {
                info: '#00f4ff',
                success: '#00ff88',
                warning: '#ffaa00',
                error: '#ff4444'
            };
            return colors[type] || colors.info;
        }


        // Check if the environment supports Service Workers
        if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost')) {
            navigator.serviceWorker.register('/sw.js').then(registration => {
                console.log('SW registered');

                // Check for updates
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    if (newWorker) {
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available
                                showNotification(
                                    '🔄 Update Available',
                                    'A new version is ready. Refresh to update.',
                                    'info',
                                    0 // Don't auto-hide
                                );
                            }
                        });
                    }
                });

                // Force complete cache on first visit
                registration.active?.postMessage({
                    type: 'CACHE_ALL_ASSETS'
                });

                // Listen for update messages
                navigator.serviceWorker.addEventListener('message', event => {
                    if (event.data.type === 'UPDATE_AVAILABLE') {
                        showNotification(
                            '🔄 App Updated',
                            'New features available! Refresh to update.',
                            'success',
                            8000
                        );
                    }
                });
            }).catch(error => {
                console.warn('SW registration failed:', error);
            });
        } else {
            console.warn('Service Workers are not supported in this environment.');
        }

        // Botão para download offline
        document.getElementById('offline-button')?.addEventListener('click', () => {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.active?.postMessage({
                        type: 'FORCE_CACHE_ALL'
                    });
                });
            }
        });

        // Show the popup if the app is not installed
        document.addEventListener('DOMContentLoaded', () => {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || navigator.standalone;
            const popup = document.getElementById('offlinePopup');
            const closePopup = document.getElementById('closePopup');

            if (!isStandalone && popup) {
                popup.style.display = 'block';

                closePopup?.addEventListener('click', () => {
                    popup.style.display = 'none';
                });
            } else if (popup) {
                // Fallback to ensure popup shows
                setTimeout(() => {
                    popup.style.display = 'block';
                }, 1000);
            }
        });
    </script>

    <script type="module">
        const isLocal = window.location.protocol === 'file:';
        const basePath = isLocal ? './' : '/';

        if (!isLocal) {
            import(`${basePath}1.js`).then(module => {
                window.RotatingSmallerSphereSort = module.default;
                window.easing = module.easing;
                console.log('1.js loaded successfully');
            }).catch(err => {
                console.error('Failed to load 1.js:', err);
            });

            import(`${basePath}2.js`).then(module => {
                const AnimationController = module.default;
                window.animationController = new AnimationController(); // Make it global
                console.log('2.js loaded successfully');
            }).catch(err => {
                console.error('Failed to load 2.js:', err);
            });
        } else {
            console.warn('Dynamic imports are not supported in the file:// protocol. Please use a local server.');
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="qr-scanner.js"></script>
</body>

</html>