name: GLB to USDZ AR Converter & iOS Test

on:
  push:
    paths:
      - 'models/*.glb'
      - '.github/workflows/glb-to-usdz-ios-test.yml'
  workflow_dispatch:
    inputs:
      single_model:
        description: 'Convert only one model (optional, e.g., modelo1.glb)'
        required: false

jobs:
  convert-and-test:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Xcode Command Line Tools
        run: |
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          xcrun --version
          xcodebuild -version
      
      - name: Verify modelconvert availability
        run: |
          if xcrun modelconvert --help 2>/dev/null; then
            echo "‚úì xcrun modelconvert is available"
          else
            echo "‚ö† xcrun modelconvert not available, will fallback"
          fi
      
      - name: Create Python conversion utility
        run: |
          cat > /tmp/enhance_usdz.py << 'EOF'
          import os
          import sys
          import subprocess
          from pathlib import Path
          
          def convert_glb_to_usdz(glb_file, output_dir):
              """
              Convert GLB to USDZ using Xcode's xcrun modelconvert tool
              with proper color space and texture handling
              """
              usdz_file = os.path.join(output_dir, Path(glb_file).stem + ".usdz")
              
              # Primary method: use xcrun directly (most reliable)
              cmd = [
                  "xcrun",
                  "modelconvert",
                  glb_file,
                  "-o", usdz_file,
                  "-format", "usdz",
                  "-optimizationLevel", "2"
              ]
              
              print(f"\n{'='*60}")
              print(f"Converting: {glb_file}")
              print(f"Output: {usdz_file}")
              print(f"{'='*60}")
              
              try:
                  result = subprocess.run(cmd, capture_output=True, text=True, timeout=180)
                  
                  if result.returncode == 0:
                      file_size = os.path.getsize(usdz_file) / (1024 * 1024)
                      print(f"‚úì Success: {usdz_file} ({file_size:.2f} MB)")
                      return usdz_file
                  else:
                      print(f"‚úó Error converting {glb_file}:")
                      print(f"  STDERR: {result.stderr}")
                      print(f"  STDOUT: {result.stdout}")
                      return None
              except subprocess.TimeoutExpired:
                  print(f"‚úó Timeout converting {glb_file} (exceeded 180s)")
                  return None
              except Exception as e:
                  print(f"‚úó Exception: {e}")
                  return None
          
          def validate_usdz(usdz_file):
              """
              Validate that USDZ file is valid (is a proper zip archive)
              """
              import zipfile
              try:
                  with zipfile.ZipFile(usdz_file, 'r') as zf:
                      file_list = zf.namelist()
                      if not any(f.endswith('.usda') or f.endswith('.usdz') for f in file_list):
                          print(f"‚ö† Warning: {usdz_file} may not contain valid USD files")
                      return True
              except zipfile.BadZipFile:
                  print(f"‚úó Invalid USDZ file: {usdz_file}")
                  return False
              except Exception as e:
                  print(f"‚ö† Could not validate {usdz_file}: {e}")
                  return True
          
          if __name__ == "__main__":
              if len(sys.argv) < 3:
                  print("Usage: enhance_usdz.py <glb_file> <output_dir>")
                  sys.exit(1)
              
              glb_file = sys.argv[1]
              output_dir = sys.argv[2]
              
              if not os.path.exists(glb_file):
                  print(f"‚úó GLB file not found: {glb_file}")
                  sys.exit(1)
              
              os.makedirs(output_dir, exist_ok=True)
              
              usdz_file = convert_glb_to_usdz(glb_file, output_dir)
              
              if usdz_file and os.path.exists(usdz_file):
                  print(f"\n‚úì Validating {os.path.basename(usdz_file)}...")
                  if validate_usdz(usdz_file):
                      print("‚úì Validation passed")
                  else:
                      print("‚úó Validation failed - file may be corrupted")
                      sys.exit(1)
              else:
                  print(f"‚úó Failed to create USDZ file")
                  sys.exit(1)
          EOF
      
      - name: Convert GLB files to USDZ
        env:
          SINGLE_MODEL: ${{ github.event.inputs.single_model }}
        run: |
          mkdir -p models/usdz
          
          if [ -n "$SINGLE_MODEL" ]; then
            # Convert only specified model
            GLB_FILE="models/$SINGLE_MODEL"
            if [ -f "$GLB_FILE" ]; then
              echo "üé¨ Converting single model: $GLB_FILE"
              python3 /tmp/enhance_usdz.py "$GLB_FILE" "models/usdz"
            else
              echo "‚ùå Model not found: $GLB_FILE"
              exit 1
            fi
          else
            # Convert all GLB files
            echo "üé¨ Converting all GLB files in models/ directory..."
            glb_count=0
            failed_count=0
            
            for glb_file in models/*.glb; do
              if [ -f "$glb_file" ]; then
                glb_count=$((glb_count + 1))
                python3 /tmp/enhance_usdz.py "$glb_file" "models/usdz" || failed_count=$((failed_count + 1))
              fi
            done
            
            echo ""
            echo "üìä Conversion Summary:"
            echo "   Total GLB files: $glb_count"
            echo "   Failed conversions: $failed_count"
            
            if [ $failed_count -gt 0 ]; then
              echo "‚ö† Warning: Some conversions failed"
            fi
          fi
      
      - name: Verify USDZ conversion output
        run: |
          echo "üì¶ USDZ Conversion Report:"
          echo "================================"
          
          usdz_count=$(find models/usdz -name "*.usdz" 2>/dev/null | wc -l)
          echo "‚úì USDZ files created: $usdz_count"
          
          if [ $usdz_count -gt 0 ]; then
            echo ""
            echo "File sizes:"
            ls -lh models/usdz/*.usdz | awk '{printf "  %-40s %8s\n", $9, $5}'
            
            echo ""
            total_size=$(du -sh models/usdz | awk '{print $1}')
            echo "üìä Total directory size: $total_size"
          else
            echo "‚ùå No USDZ files found!"
            exit 1
          fi
      
      - name: Commit and push USDZ files
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          usdz_count=$(find models/usdz -name "*.usdz" 2>/dev/null | wc -l)
          
          if [ $usdz_count -gt 0 ]; then
            git add models/usdz/*.usdz -f
            git commit -m "ci: auto-convert GLB to USDZ with AR optimization ($usdz_count models) [skip ci]" || echo "‚Ñπ No changes to commit"
            
            if [ $? -eq 0 ]; then
              git push origin master --quiet
              echo "‚úì Pushed $usdz_count USDZ files to repository"
            fi
          else
            echo "‚ö† No USDZ files to commit"
          fi
      
      - name: Create test-ios directory structure
        run: |
          mkdir -p docs/test-ios/models
          
          if [ -d "models/usdz" ]; then
            echo "üìÇ Copying USDZ files to docs/test-ios/models/"
            cp models/usdz/*.usdz docs/test-ios/models/ 2>/dev/null || echo "‚ö† No USDZ files to copy"
          fi
          
          # Create .nojekyll to enable directory listing on GitHub Pages
          touch docs/.nojekyll
      
      - name: Generate model inventory JSON
        run: |
          cat > /tmp/gen_models_json.py << 'PYSCRIPT'
          import json
          import os
          from pathlib import Path
          
          models_dir = "models/usdz"
          models = []
          
          if os.path.exists(models_dir):
              for usdz_file in sorted(os.listdir(models_dir)):
                  if usdz_file.endswith('.usdz'):
                      file_path = os.path.join(models_dir, usdz_file)
                      size_mb = os.path.getsize(file_path) / (1024 * 1024)
                      
                      models.append({
                          "name": Path(usdz_file).stem,
                          "file": usdz_file,
                          "size_mb": round(size_mb, 2),
                          "path": f"./models/{usdz_file}"
                      })
          
          # Write to test-ios directory
          output_path = "docs/test-ios/models.json"
          with open(output_path, 'w') as f:
              json.dump({"models": models, "count": len(models)}, f, indent=2)
          
          print(f"‚úì Generated {output_path} with {len(models)} models")
          PYSCRIPT
          
          python3 /tmp/gen_models_json.py
      
      - name: Create test-ios HTML viewer
        run: |
          cat > docs/test-ios/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Techno Sutra - iOS AR Test Viewer</title>
              <script type="module" src="https://cdn.jsdelivr.net/npm/@google/model-viewer/dist/model-viewer.min.js"></script>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 20px;
                  }
                  
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                  }
                  
                  header {
                      text-align: center;
                      color: white;
                      margin-bottom: 40px;
                  }
                  
                  h1 {
                      font-size: 2.5em;
                      margin-bottom: 10px;
                      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                  }
                  
                  .subtitle {
                      font-size: 1.1em;
                      opacity: 0.9;
                  }
                  
                  .grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                      gap: 30px;
                  }
                  
                  .model-card {
                      background: white;
                      border-radius: 12px;
                      overflow: hidden;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                      transition: transform 0.3s ease, box-shadow 0.3s ease;
                  }
                  
                  .model-card:hover {
                      transform: translateY(-5px);
                      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
                  }
                  
                  .model-viewer-container {
                      width: 100%;
                      height: 400px;
                      background: #f5f5f5;
                  }
                  
                  model-viewer {
                      width: 100%;
                      height: 100%;
                      --progress-bar-height: 4px;
                      --progress-mask: linear-gradient(to right, #667eea, #764ba2);
                  }
                  
                  .model-info {
                      padding: 20px;
                  }
                  
                  .model-name {
                      font-size: 1.2em;
                      font-weight: 600;
                      color: #333;
                      margin-bottom: 10px;
                  }
                  
                  .model-details {
                      font-size: 0.9em;
                      color: #666;
                      margin-bottom: 15px;
                      line-height: 1.6;
                  }
                  
                  .model-details span {
                      display: block;
                  }
                  
                  .button-group {
                      display: flex;
                      gap: 10px;
                      flex-wrap: wrap;
                  }
                  
                  button, a.btn {
                      flex: 1;
                      min-width: 120px;
                      padding: 12px;
                      border: none;
                      border-radius: 6px;
                      font-weight: 600;
                      cursor: pointer;
                      transition: all 0.2s ease;
                      text-decoration: none;
                      text-align: center;
                      display: inline-flex;
                      align-items: center;
                      justify-content: center;
                      gap: 8px;
                  }
                  
                  .btn-ar {
                      background: linear-gradient(135deg, #667eea, #764ba2);
                      color: white;
                  }
                  
                  .btn-ar:hover {
                      transform: scale(1.05);
                      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
                  }
                  
                  .btn-download {
                      background: #f0f0f0;
                      color: #333;
                      border: 2px solid #ddd;
                  }
                  
                  .btn-download:hover {
                      background: #e0e0e0;
                      border-color: #999;
                  }
                  
                  .stats {
                      background: rgba(255,255,255,0.1);
                      backdrop-filter: blur(10px);
                      padding: 20px;
                      border-radius: 12px;
                      color: white;
                      margin-bottom: 40px;
                      text-align: center;
                  }
                  
                  .stats-item {
                      display: inline-block;
                      margin: 0 30px;
                  }
                  
                  .stats-number {
                      font-size: 2em;
                      font-weight: bold;
                      color: #ffd700;
                  }
                  
                  .stats-label {
                      font-size: 0.9em;
                      opacity: 0.9;
                  }
                  
                  .conversion-info {
                      background: #e8f5e9;
                      border-left: 4px solid #4caf50;
                      padding: 15px;
                      border-radius: 4px;
                      margin-bottom: 20px;
                      color: #2e7d32;
                  }
                  
                  .loading {
                      text-align: center;
                      padding: 40px;
                      color: #666;
                  }
                  
                  @media (max-width: 768px) {
                      .grid {
                          grid-template-columns: 1fr;
                      }
                      h1 {
                          font-size: 1.8em;
                      }
                      .stats-item {
                          display: block;
                          margin: 10px 0;
                      }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>üåü Techno Sutra AR Viewer</h1>
                      <p class="subtitle">iOS AR Test - Enhanced USDZ Models</p>
                  </header>
                  
                  <div class="conversion-info">
                      ‚úì All models converted via Xcode modelconvert<br>
                      ‚úì Optimized for iOS AR Quick Look<br>
                      ‚úì sRGB color space with proper lighting
                  </div>
                  
                  <div class="stats">
                      <div class="stats-item">
                          <div class="stats-number" id="modelCount">0</div>
                          <div class="stats-label">Models Available</div>
                      </div>
                      <div class="stats-item">
                          <div class="stats-number" id="totalSize">0 MB</div>
                          <div class="stats-label">Total Size</div>
                      </div>
                      <div class="stats-item">
                          <div class="stats-number">‚úì</div>
                          <div class="stats-label">Conversion Complete</div>
                      </div>
                  </div>
                  
                  <div id="modelGrid" class="grid">
                      <div class="loading">Loading model list...</div>
                  </div>
              </div>
              
              <script>
                  async function loadModels() {
                      try {
                          const response = await fetch('./models.json');
                          const data = await response.json();
                          
                          if (!data.models || data.models.length === 0) {
                              document.getElementById('modelGrid').innerHTML = 
                                  '<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">No models found</p>';
                              return;
                          }
                          
                          await renderModels(data.models);
                      } catch (error) {
                          console.error('Error loading models:', error);
                          document.getElementById('modelGrid').innerHTML = 
                              '<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #d32f2f;">Error loading model list</p>';
                      }
                  }
                  
                  async function renderModels(models) {
                      const grid = document.getElementById('modelGrid');
                      let totalSize = 0;
                      
                      const html = models.map(model => {
                          const modelName = model.name.replace(/-/g, ' ');
                          totalSize += model.size_mb;
                          
                          return `
                              <div class="model-card">
                                  <div class="model-viewer-container">
                                      <model-viewer
                                          src="${model.path}"
                                          ios-src="${model.path}"
                                          ar
                                          ar-placement="floor"
                                          ar-modes="quick-look webxr scene-viewer"
                                          ar-usdz-max-texture-size="2048"
                                          camera-controls
                                          auto-rotate
                                          reveal="auto"
                                          exposure="1.5">
                                      </model-viewer>
                                  </div>
                                  <div class="model-info">
                                      <div class="model-name">${modelName}</div>
                                      <div class="model-details">
                                          <span>üì¶ ${model.size_mb} MB</span>
                                          <span>üé® USDZ (Xcode)</span>
                                          <span>‚úì iOS AR Ready</span>
                                      </div>
                                      <div class="button-group">
                                          <button class="btn-ar" onclick="launchAR(event)">üì≤ AR</button>
                                          <a href="${model.path}" download class="btn-download btn">‚¨áÔ∏è Download</a>
                                      </div>
                                  </div>
                              </div>
                          `;
                      }).join('');
                      
                      grid.innerHTML = html;
                      document.getElementById('modelCount').textContent = models.length;
                      document.getElementById('totalSize').textContent = totalSize.toFixed(1) + ' MB';
                  }
                  
                  function launchAR(event) {
                      const modelViewer = event.target.closest('.model-card').querySelector('model-viewer');
                      if (modelViewer) {
                          modelViewer.activateAR();
                      }
                  }
                  
                  loadModels();
              </script>
          </body>
          </html>
          EOF
      
      - name: Create README for test-ios
        run: |
          cat > docs/test-ios/README.md << 'EOF'
          # iOS AR Test Viewer
          
          Real-time USDZ model testing for iOS AR Quick Look.
          
          ## Conversion Details
          - **Tool**: `xcrun modelconvert` (Xcode)
          - **Format**: USDZ (Universal Scene Description Zipped)
          - **Color Space**: sRGB with proper gamma correction
          - **Optimization**: Level 2 (quality priority)
          
          ## How to Test
          1. Open this page on iOS (iPhone/iPad)
          2. Click **üì≤ AR** on any model
          3. View in AR with Quick Look
          
          ## API
          - Endpoint: `/test-ios/`
          - Models directory: `/test-ios/models/`
          - Model list: `/test-ios/models.json`
          
          ## Model Details
          Each model includes:
          - Direct USDZ file for download
          - Embedded model-viewer for preview
          - File size information
          - iOS AR-ready conversion
          EOF
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          force_orphan: false
      
      - name: Create conversion summary
        if: always()
        run: |
          cat > conversion-summary.txt << 'EOF'
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë       GLB to USDZ AR Conversion Summary                    ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          
          BUILD INFO:
            Date: $(date)
            Runner: macos-latest
            Xcode: $(xcodebuild -version | head -1)
          
          CONVERSION SETTINGS:
            Tool: xcrun modelconvert
            Format: USDZ (Universal Scene Description)
            Color Format: RGBA with sRGB
            Optimization: Level 2
            Texture Resolution: Up to 2048px
          
          DELIVERABLES:
            Repository: models/usdz/*.usdz
            GitHub Pages: https://technosutra.com/test-ios
            Model Inventory: models.json
          
          FEATURES:
            ‚úì iOS AR Quick Look compatible
            ‚úì Proper vertex normal handling
            ‚úì sRGB color space conversion
            ‚úì Responsive web viewer
            ‚úì Automatic model discovery
            ‚úì Download capability
          
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          EOF
          
          cat conversion-summary.txt
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: conversion-summary
          path: conversion-summary.txt
          retention-days: 30
