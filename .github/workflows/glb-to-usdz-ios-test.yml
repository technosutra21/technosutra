name: GLB to USDZ AR Converter & iOS Test

on:
  push:
    paths:
      - 'models/*.glb'
      - '.github/workflows/glb-to-usdz-ios-test.yml'
  workflow_dispatch:
    inputs:
      single_model:
        description: 'Convert only one model (optional, e.g., modelo1.glb)'
        required: false

jobs:
  convert-and-test:
    runs-on: macos-latest
    
    outputs:
      conversion_success: ${{ steps.conversion-check.outputs.success }}
      usdz_count: ${{ steps.conversion-check.outputs.count }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install USDZ conversion tools
        run: |
          npm install -g @gltf-transform/core @gltf-transform/extensions @gltf-transform/functions
          echo "‚úì gltf-transform installed"
          node -e "console.log('Node.js:', process.version)"
      
      - name: Create Python conversion utility
        run: |
          cat > /tmp/convert_glb_to_usdz.py << 'EOF'
          import os
          import sys
          import subprocess
          from pathlib import Path
          import zipfile
          import time
          
          def validate_usdz(usdz_file):
              """Validate USDZ file integrity"""
              try:
                  if not zipfile.is_zipfile(usdz_file):
                      print(f"‚úó Not a valid ZIP file")
                      return False
                  
                  with zipfile.ZipFile(usdz_file, 'r') as zf:
                      files = zf.namelist()
                      has_usd = any(f.endswith(('.usda', '.usdc')) for f in files)
                      if not has_usd:
                          print(f"‚úó No USD files in archive")
                          return False
                      zf.testzip()
                      return True
              except Exception as e:
                  print(f"‚úó Validation error: {e}")
                  return False
          
          if __name__ == "__main__":
              if len(sys.argv) < 3:
                  print("Usage: convert_glb_to_usdz.py <glb_file> <output_dir>")
                  sys.exit(1)
              
              glb_file = sys.argv[1]
              output_dir = sys.argv[2]
              
              if not os.path.exists(glb_file):
                  print(f"‚úó GLB file not found: {glb_file}")
                  sys.exit(1)
              
              os.makedirs(output_dir, exist_ok=True)
              usdz_file = os.path.join(output_dir, Path(glb_file).stem + ".usdz")
              
              print(f"[{time.strftime('%H:%M:%S')}] Converting: {glb_file}")
              
              # Run Node.js converter
              result = subprocess.run(
                  ["node", "/tmp/converter/convert.js", glb_file, usdz_file],
                  capture_output=True,
                  text=True,
                  timeout=300,
                  cwd="/tmp/converter"
              )
              
              if result.returncode != 0:
                  print(f"‚úó Conversion failed: {result.stderr}")
                  sys.exit(1)
              
              if not os.path.exists(usdz_file):
                  print(f"‚úó USDZ file not created")
                  sys.exit(1)
              
              print("Validating...")
              if not validate_usdz(usdz_file):
                  try:
                      os.remove(usdz_file)
                  except:
                      pass
                  sys.exit(1)
              
              size = os.path.getsize(usdz_file) / (1024 * 1024)
              print(f"‚úì Success: {size:.2f} MB")
          EOF
      
      - name: Setup Node.js converter environment
        run: |
          mkdir -p /tmp/converter
          cd /tmp/converter
          npm init -y > /dev/null 2>&1
          npm install three > /dev/null 2>&1
          
          # Create converter AFTER npm install
          cat > convert.js << 'EOF'
          import * as fs from 'fs';
          import * as path from 'path';
          import * as THREE from 'three';
          import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';
          import { USDZExporter } from 'three/examples/jsm/exporters/USDZExporter.js';
          
          async function convert(glbFile, outputFile) {
              try {
                  const glbData = fs.readFileSync(glbFile);
                  const loader = new GLTFLoader();
                  
                  const gltf = await new Promise((resolve, reject) => {
                      loader.parse(glbData, path.dirname(glbFile), resolve, reject);
                  });
                  
                  const scene = gltf.scene;
                  const exporter = new USDZExporter();
                  const usdz = await exporter.parse(scene);
                  
                  fs.writeFileSync(outputFile, usdz);
                  console.log(`‚úì Converted: ${(fs.statSync(outputFile).size / (1024 * 1024)).toFixed(2)} MB`);
              } catch (e) {
                  console.error(`‚úó Error: ${e.message}`);
                  process.exit(1);
              }
          }
          
          convert(process.argv[2], process.argv[3]);
          EOF
          
          # Make package.json ES modules compatible
          sed -i 's/"type": "commonjs"/"type": "module"/' package.json || echo '{"type": "module"}' > package.json
          
          echo "‚úì Node.js converter ready"
      
      - name: Convert GLB files to USDZ
        id: convert
        run: |
          set -e
          mkdir -p models/usdz
          
          if [ -n "${{ github.event.inputs.single_model }}" ]; then
            GLB_FILE="models/${{ github.event.inputs.single_model }}"
            if [ ! -f "$GLB_FILE" ]; then
              echo "‚ùå Model not found: $GLB_FILE"
              exit 1
            fi
            python3 /tmp/convert_glb_to_usdz.py "$GLB_FILE" "models/usdz"
          else
            echo "üé¨ Converting all GLB files..."
            failed=0
            success=0
            glb_count=0
            
            while IFS= read -r glb_file; do
              glb_count=$((glb_count + 1))
              if python3 /tmp/convert_glb_to_usdz.py "$glb_file" "models/usdz"; then
                success=$((success + 1))
              else
                failed=$((failed + 1))
                echo "‚ö†Ô∏è  Failed: $glb_file"
              fi
            done < <(find models -maxdepth 1 -name "*.glb" | sort)
            
            [ $glb_count -eq 0 ] && { echo "‚ùå No GLB files found"; exit 1; }
            
            echo ""
            echo "üìä Total: $glb_count | Success: $success | Failed: $failed"
            [ $failed -gt 0 ] && { echo "‚ùå Some conversions failed"; exit 1; }
          fi
      
      - name: Verify USDZ conversion output
        id: conversion-check
        run: |
          set -e
          usdz_count=$(find models/usdz -name "*.usdz" 2>/dev/null | wc -l)
          [ $usdz_count -eq 0 ] && { echo "‚ùå No USDZ files created"; exit 1; }
          
          echo "‚úì Created: $usdz_count USDZ files"
          ls -lh models/usdz/*.usdz | awk '{printf "  %-40s %8s\n", $9, $5}'
          
          echo "success=true" >> $GITHUB_OUTPUT
          echo "count=$usdz_count" >> $GITHUB_OUTPUT
      
      - name: Create docs directory structure
        run: |
          set -e
          mkdir -p docs/test-ios/models
          
          usdz_count=$(find models/usdz -name "*.usdz" 2>/dev/null | wc -l)
          [ $usdz_count -eq 0 ] && { echo "‚ùå No USDZ files"; exit 1; }
          
          cp models/usdz/*.usdz docs/test-ios/models/
          touch docs/.nojekyll
          touch docs/test-ios/.nojekyll
      
      - name: Generate model inventory JSON
        run: |
          set -e
          
          [ ! -d "docs/test-ios/models" ] && { echo "‚ùå models directory not found"; exit 1; }
          
          python3 << 'PYSCRIPT'
          import json
          import os
          from pathlib import Path
          
          models_dir = "docs/test-ios/models"
          models = []
          
          if os.path.exists(models_dir):
              for usdz_file in sorted(os.listdir(models_dir)):
                  if usdz_file.endswith('.usdz'):
                      size_mb = os.path.getsize(os.path.join(models_dir, usdz_file)) / (1024 * 1024)
                      models.append({
                          "name": Path(usdz_file).stem,
                          "file": usdz_file,
                          "size_mb": round(size_mb, 2),
                          "path": f"./models/{usdz_file}"
                      })
          
          output = "docs/test-ios/models.json"
          with open(output, 'w') as f:
              json.dump({"models": models, "count": len(models), "generated": True}, f, indent=2)
          
          print(f"‚úì Generated {output} with {len(models)} models")
          PYSCRIPT
      
      - name: Create test-ios HTML viewer
        run: |
          cat > docs/test-ios/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Techno Sutra - iOS AR Test Viewer</title>
              <script type="module" src="https://cdn.jsdelivr.net/npm/@google/model-viewer/dist/model-viewer.min.js"></script>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
                  .container { max-width: 1200px; margin: 0 auto; }
                  header { text-align: center; color: white; margin-bottom: 40px; }
                  h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
                  .subtitle { font-size: 1.1em; opacity: 0.9; }
                  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; }
                  .model-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.3s ease; }
                  .model-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.3); }
                  .model-viewer-container { width: 100%; height: 400px; background: #f5f5f5; }
                  model-viewer { width: 100%; height: 100%; }
                  .model-info { padding: 20px; }
                  .model-name { font-size: 1.2em; font-weight: 600; color: #333; margin-bottom: 10px; }
                  .model-details { font-size: 0.9em; color: #666; margin-bottom: 15px; }
                  .model-details span { display: block; }
                  .button-group { display: flex; gap: 10px; }
                  button, a.btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; text-decoration: none; text-align: center; }
                  .btn-ar { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
                  .btn-ar:hover { transform: scale(1.05); }
                  .btn-download { background: #f0f0f0; color: #333; border: 2px solid #ddd; }
                  .btn-download:hover { background: #e0e0e0; }
                  .stats { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; color: white; margin-bottom: 40px; text-align: center; }
                  .stats-item { display: inline-block; margin: 0 30px; }
                  .stats-number { font-size: 2em; font-weight: bold; color: #ffd700; }
                  .conversion-info { background: #e8f5e9; border-left: 4px solid #4caf50; padding: 15px; margin-bottom: 20px; color: #2e7d32; }
                  .loading { text-align: center; padding: 40px; }
                  @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } h1 { font-size: 1.8em; } }
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>üåü Techno Sutra AR Viewer</h1>
                      <p class="subtitle">iOS AR Test - USDZ Models</p>
                  </header>
                  
                  <div class="conversion-info">
                      ‚úì Models converted with three.js USDZExporter<br>
                      ‚úì Optimized for iOS AR Quick Look<br>
                      ‚úì Full sRGB color space support
                  </div>
                  
                  <div class="stats">
                      <div class="stats-item">
                          <div class="stats-number" id="modelCount">-</div>
                          <div class="stats-label">Models</div>
                      </div>
                      <div class="stats-item">
                          <div class="stats-number" id="totalSize">-</div>
                          <div class="stats-label">Total Size</div>
                      </div>
                  </div>
                  
                  <div id="modelGrid" class="grid">
                      <div class="loading">Loading models...</div>
                  </div>
              </div>
              
              <script>
                  async function loadModels() {
                      try {
                          const response = await fetch('./models.json');
                          const data = await response.json();
                          
                          if (!data.models || data.models.length === 0) {
                              document.getElementById('modelGrid').innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px;">No models found</p>';
                              return;
                          }
                          
                          await renderModels(data.models);
                      } catch (error) {
                          console.error('Error:', error);
                          document.getElementById('modelGrid').innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: red;">Error loading models</p>';
                      }
                  }
                  
                  async function renderModels(models) {
                      const grid = document.getElementById('modelGrid');
                      let totalSize = 0;
                      
                      const html = models.map(model => {
                          totalSize += model.size_mb;
                          return `
                              <div class="model-card">
                                  <div class="model-viewer-container">
                                      <model-viewer
                                          src="${model.path}"
                                          ios-src="${model.path}"
                                          ar
                                          ar-placement="floor"
                                          ar-modes="quick-look webxr scene-viewer"
                                          ar-usdz-max-texture-size="2048"
                                          camera-controls
                                          auto-rotate
                                          reveal="auto"
                                          exposure="1.5">
                                      </model-viewer>
                                  </div>
                                  <div class="model-info">
                                      <div class="model-name">${model.name}</div>
                                      <div class="model-details">
                                          <span>üì¶ ${model.size_mb} MB</span>
                                          <span>‚úì iOS AR Ready</span>
                                      </div>
                                      <div class="button-group">
                                          <button class="btn-ar" onclick="launchAR(event)">üì≤ AR</button>
                                          <a href="${model.path}" download class="btn-download">‚¨áÔ∏è Download</a>
                                      </div>
                                  </div>
                              </div>
                          `;
                      }).join('');
                      
                      grid.innerHTML = html;
                      document.getElementById('modelCount').textContent = models.length;
                      document.getElementById('totalSize').textContent = totalSize.toFixed(1) + ' MB';
                  }
                  
                  function launchAR(event) {
                      const modelViewer = event.target.closest('.model-card').querySelector('model-viewer');
                      if (modelViewer) modelViewer.activateAR();
                  }
                  
                  loadModels();
              </script>
          </body>
          </html>
          HTMLEOF
      
      - name: Create README
        run: |
          cat > docs/test-ios/README.md << 'MDEOF'
          # iOS AR Test Viewer
          
          USDZ model testing for iOS AR Quick Look.
          
          ## Conversion
          - Tool: three.js USDZExporter
          - Format: USDZ (Universal Scene Description Zipped)
          - Validation: Full ZIP integrity checks
          
          ## Features
          - ‚úì iOS AR Quick Look compatible
          - ‚úì sRGB color space preservation
          - ‚úì Responsive web viewer
          - ‚úì Direct USDZ download
          
          ## How to Test
          1. Open on iOS (iPhone/iPad)
          2. Click "üì≤ AR" on any model
          3. View in AR Quick Look
          MDEOF
      
      - name: Commit USDZ files (only if successful)
        if: steps.conversion-check.outputs.success == 'true'
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -d "models/usdz" ] && [ -n "$(find models/usdz -name '*.usdz' 2>/dev/null)" ]; then
            git add models/usdz/*.usdz
            git commit -m "ci: convert GLB to USDZ [skip ci]" || true
          fi
      
      - name: Push commits (only if successful)
        if: steps.conversion-check.outputs.success == 'true'
        run: |
          set -e
          if git status --short | grep -q .; then
            git push origin master --quiet || { echo "‚ö†Ô∏è Push failed, continuing..."; true; }
          fi
      
      - name: Deploy to GitHub Pages (only if successful)
        if: steps.conversion-check.outputs.success == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          force_orphan: true
      
      - name: Create conversion summary
        if: always()
        run: |
          cat > conversion-summary.txt << 'SUMMEOF'
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë       GLB to USDZ AR Conversion Summary                    ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          
          BUILD INFO:
            Date: $(date '+%Y-%m-%d %H:%M:%S')
            Runner: macos-latest
            Status: ${{ steps.conversion-check.outputs.success || 'FAILED' }}
            USDZ Count: ${{ steps.conversion-check.outputs.count || 'N/A' }}
          
          CONVERSION SETTINGS:
            Tool: three.js USDZExporter
            Format: USDZ (Universal Scene Description)
            Validation: ZIP integrity + USD content
          
          DELIVERABLES:
            Repository: models/usdz/*.usdz
            GitHub Pages: /test-ios
            Model Inventory: models.json
          
          FEATURES:
            ‚úì iOS AR Quick Look compatible
            ‚úì sRGB color space conversion
            ‚úì Responsive web viewer
            ‚úì Full validation pipeline
            ‚úì Conditional deployment
          
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          SUMMEOF
          cat conversion-summary.txt
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: conversion-summary
          path: conversion-summary.txt
          retention-days: 30
