<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Techno Sutra AR - Experi√™ncia Imersiva</title>
    <meta name="description" content="Explore os 56 cap√≠tulos do Avatamsaka Sutra em realidade aumentada">
    <link rel="icon" type="image/png" href="/imgs/icon.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #000;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        
        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Camera background video */
        #cameraBackground {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 0;
            background: #000;
            display: none;
        }
        
        /* Model viewer */
        model-viewer {
            position: relative;
            z-index: 1;
            width: 100%;
            height: 100vh;
            background-color: transparent;
            display: block;
        }

        /* AR button styling */
        .btn {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* AR button slot positioning */
        model-viewer > [slot="ar-button"] {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 20px;
            z-index: 3;
        }
        
        /* Controls */
        .controls {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 100;
        }
        
        /* Navigation arrows */
        .nav-arrow {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .nav-arrow:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-50%) scale(1.1);
        }
        
        .nav-arrow.left { left: 15px; }
        .nav-arrow.right { right: 15px; }
        
        /* Status */
        .status {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 14px;
            text-align: center;
            backdrop-filter: blur(10px);
            z-index: 200;
            transform: translateY(-100px);
            transition: transform 0.3s ease;
        }
        
        .status.show {
            transform: translateY(0);
        }
        
        /* Error */
        .error {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            z-index: 1001;
        }
        
        .error.show {
            display: flex;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .nav-arrow {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .nav-arrow.left { left: 10px; }
            .nav-arrow.right { right: 10px; }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <h2>Techno Sutra AR</h2>
        <p>Preparando experi√™ncia...</p>
    </div>
    
    <!-- Error -->
    <div class="error" id="error">
        <h1 style="font-size: 4rem; margin-bottom: 1rem;">404</h1>
        <h2>Modelo n√£o encontrado</h2>
        <p>Redirecionando para o modelo padr√£o...</p>
    </div>
    
    <!-- Status -->
    <div class="status" id="status"></div>

    <!-- Camera background video -->
    <video id="cameraBackground" autoplay playsinline muted></video>
    
    <!-- Model viewer with cost-saving configurations and auto GLB-to-USDZ conversion -->
    <model-viewer
        id="modelViewer"
        alt="Modelo 3D Interativo"
        src=""
        loading="eager"
        reveal="auto"
        ar
        ar-placement="floor"
        ar-modes="quick-look webxr scene-viewer"
        ar-usdz-max-texture-size="1024"
        camera-controls
        touch-action="pan-y"
        ar-scale="auto"
        auto-rotate
        auto-rotate-delay="1000"
        rotation-per-second="15deg"
        exposure="0.9"
        shadow-intensity="0.5"
        interaction-prompt="none"
        interaction-prompt-style="basic"
        max-camera-orbit-distance="auto"
        min-camera-orbit-distance="5%"
        camera-orbit="0deg 75deg 105%"
        field-of-view="30deg"
        camera-target="0m 0m 0m"
        orientation="0deg 0deg -90deg">

        <button slot="ar-button" class="btn">üì≤ Abrir em AR</button>

    </model-viewer>
    
    <!-- Navigation arrows -->
    <button class="nav-arrow left" id="prevBtn" onclick="changeModel(-1)">‚Äπ</button>
    <button class="nav-arrow right" id="nextBtn" onclick="changeModel(1)">‚Ä∫</button>
    
    <!-- Controls -->
    <div class="controls">
        <a href="index.html" class="btn">üè† Home</a>
    </div>
    
    <!-- Scripts -->
    <!-- Configure decoders BEFORE loading model-viewer -->
    <script>
        // Global configuration for model-viewer decoders
        self.ModelViewerElement = self.ModelViewerElement || {};
        
        // Configure DRACO decoder location
        self.ModelViewerElement.dracoDecoderLocation = 'https://www.gstatic.com/draco/versioned/decoders/1.5.6/';
        
        // Configure Meshopt decoder location  
        self.ModelViewerElement.meshoptDecoderLocation = 'https://unpkg.com/meshoptimizer@0.18.1/meshopt_decoder.js';
        
        // Configure KTX2 transcoder location
        self.ModelViewerElement.ktx2TranscoderLocation = 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/libs/basis/';
    </script>
    
    <!-- Load MeshoptDecoder globally -->
    <script src="https://unpkg.com/meshoptimizer@0.18.1/meshopt_decoder.js"></script>
    <script>
        // Ensure MeshoptDecoder is available globally
        (function () {
            if (window.MeshoptDecoder) return;
            if (typeof window.MeshoptDecoderReady === 'function') {
                try {
                    window.MeshoptDecoder = window.MeshoptDecoderReady();
                    return;
                } catch (e) {
                    console.warn('MeshoptDecoderReady invocation failed:', e);
                }
            }
            if (window.meshopt) {
                window.MeshoptDecoder = window.meshopt;
            }
        })();
    </script>
    
    <!-- Load model-viewer -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
    
    <script>
        // Global variables
        let currentModel = 1;
        const totalModels = 56;
        const modelViewer = document.getElementById('modelViewer');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const status = document.getElementById('status');
        const cameraVideo = document.getElementById('cameraBackground');
        let cameraStream = null;
        let availableModels = [];
        
        // Initialize
        async function init() {
            const params = new URLSearchParams(window.location.search);
            const requestedModel = parseInt(params.get('model')) || 1;
            
            // Load available models list
            await loadAvailableModels();
            
            // Validate requested model exists
            currentModel = availableModels.includes(requestedModel) ? requestedModel : 1;
            
            // Start inline camera background
            startCameraBackground();
            
            loadModel(currentModel);
        }
        
        // Load available models list
        async function loadAvailableModels() {
            try {
                // Try to load from models.json first
                const response = await fetch('./models/models.json');
                if (response.ok) {
                    const data = await response.json();
                    availableModels = data.models.map(m => m.id);
                    console.log('Available models loaded from JSON:', availableModels);
                    return;
                }
            } catch (error) {
                console.log('models.json not found, checking models dynamically...');
            }
            
            // Fallback: check which models exist
            const checkPromises = [];
            for (let i = 1; i <= 56; i++) {
                checkPromises.push(
                    fetch(`./models/modelo${i}.glb`, { method: 'HEAD' })
                        .then(response => {
                            if (response.ok) {
                                availableModels.push(i);
                            }
                        })
                        .catch(() => {
                            // Model doesn't exist, skip
                        })
                );
            }
            
            await Promise.all(checkPromises);
            availableModels.sort((a, b) => a - b);
            console.log('Available models detected:', availableModels);
        }
        
        // Load model - use GLB, let model-viewer auto-convert to USDZ for iOS
        function loadModel(modelId) {
            const glbPath = `models/modelo${modelId}.glb`;
            
            // Check if model exists before loading
            if (!availableModels.includes(modelId)) {
                console.warn(`Model ${modelId} not available, falling back to model 1`);
                showStatus(`Modelo ${modelId} n√£o encontrado`, 'error', 3000);
                modelId = 1;
            }
            
            // Simply set src - model-viewer handles GLB-to-USDZ conversion automatically
            modelViewer.setAttribute('src', glbPath);
            
            // Update URL
            const newUrl = `${window.location.pathname}?model=${modelId}`;
            window.history.replaceState({}, '', newUrl);
            
            // Update title
            document.title = `Techno Sutra AR - Modelo ${modelId}`;
        }
        
        // Change model
        function changeModel(direction) {
            const currentIndex = availableModels.indexOf(currentModel);
            let newIndex = currentIndex + direction;
            
            // Find next available model in the direction
            if (newIndex >= 0 && newIndex < availableModels.length) {
                currentModel = availableModels[newIndex];
                loadModel(currentModel);
                showStatus(`Modelo ${currentModel}/${totalModels} (${currentIndex + 1}/${availableModels.length} dispon√≠veis)`);
            } else {
                // Show boundary message
                if (direction > 0) {
                    showStatus('√öltimo modelo dispon√≠vel', 'info', 2000);
                } else {
                    showStatus('Primeiro modelo dispon√≠vel', 'info', 2000);
                }
            }
        }
        
        // Activate AR
        async function activateAR() {
            try {
                if (!('activateAR' in modelViewer) || (modelViewer.canActivateAR === false)) {
                    showStatus('AR n√£o suportado neste dispositivo ou contexto', 'error', 3000);
                    return;
                }
                stopCameraBackground();
                const result = await (modelViewer.activateAR?.());
                if (result === false) {
                    showStatus('Falha ao iniciar AR', 'error', 3000);
                    startCameraBackground();
                }
            } catch (e) {
                showStatus('Erro ao ativar AR', 'error', 3000);
                console.error('AR Error:', e);
                startCameraBackground();
            }
        }
        
        // Reset camera
        function resetCamera() {
            modelViewer.resetTurntableRotation?.();
            modelViewer.jumpCameraToGoal?.();
            showStatus('C√¢mera resetada');
        }
        
        // Show status message
        function showStatus(message, type = 'info', duration = 2000) {
            status.textContent = message;
            status.className = `status show ${type}`;
            
            setTimeout(() => {
                status.className = 'status';
            }, duration);
        }

        // When model loads
        modelViewer.addEventListener('load', () => {
            loading.classList.add('hidden');
            showStatus(`Modelo ${currentModel} carregado`);
            
            // Ensure model faces camera properly
            setTimeout(() => {
                // Reset camera to frontal view
                modelViewer.cameraOrbit = '0deg 75deg 105%';
                
                // Apply orientation to model - orientation rotates the model itself
                try {
                    const model = modelViewer.model;
                    if (model && model.scene) {
                        // Apply -90 degree pitch to face forward (negative pitch = tilt forward)
                        model.scene.rotation.x = 0; // No roll
                        model.scene.rotation.y = Math.PI; // 180 degrees to face forward  
                        model.scene.rotation.z = 0; // No yaw
                        modelViewer.updateChange();
                    }
                } catch (e) {
                    console.log('Model orientation applied via attribute');
                }
            }, 500);
        });
        
        modelViewer.addEventListener('error', (e) => {
            console.error('Model loading error:', e);
            loading.classList.add('hidden');
            
            // Try to find next available model
            const currentIndex = availableModels.indexOf(currentModel);
            let fallbackModel = 1;
            
            if (currentIndex > 0) {
                fallbackModel = availableModels[0]; // First available model
            }
            
            showStatus(`Erro ao carregar modelo ${currentModel}, tentando ${fallbackModel}...`, 'error', 2000);
            
            setTimeout(() => {
                currentModel = fallbackModel;
                loadModel(fallbackModel);
            }, 2000);
        });
        
        // AR session lifecycle
        modelViewer.addEventListener('ar-status', (event) => {
            if (event.detail.status === 'session-started') {
                showStatus('Sess√£o AR iniciada');
                hideCameraBackground();
            } else if (event.detail.status === 'not-presenting') {
                showStatus('Sess√£o AR encerrada');
                startCameraBackground();
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                changeModel(-1);
            } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                changeModel(1);
            } else if (e.key === 'r' || e.key === 'R') {
                resetCamera();
            } else if (e.key === ' ') {
                e.preventDefault();
                activateAR();
            }
        });
        
        // Camera background helpers
        async function startCameraBackground() {
            if (cameraStream && cameraStream.active) {
                cameraVideo.style.display = 'block';
                return;
            }
            
            // Feature-detect mediaDevices to avoid undefined getUserMedia errors in unsupported contexts
            const mediaDevices = navigator.mediaDevices;
            if (!mediaDevices || typeof mediaDevices.getUserMedia !== 'function') {
                console.warn('Camera background unavailable: mediaDevices.getUserMedia not supported or insecure context');
                cameraVideo.style.display = 'none';
                return;
            }
            
            // Check for secure context (HTTPS required for camera access)
            // Note: localhost is considered secure, but some browsers may still restrict access
            if (window.isSecureContext === false) {
                const hostname = window.location.hostname;
                if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname.startsWith('192.168.') || hostname.startsWith('10.')) {
                    console.warn('Camera background may be unavailable in local development environment');
                } else {
                    console.warn('Camera background unavailable: insecure context (requires HTTPS)');
                    cameraVideo.style.display = 'none';
                    return;
                }
            }
            
            try {
                const constraints = {
                    video: { 
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };
                cameraStream = await mediaDevices.getUserMedia(constraints);
                cameraVideo.srcObject = cameraStream;
                cameraVideo.style.display = 'block';
                console.log('Camera background started successfully');
            } catch (err) {
                console.warn('Environment camera failed, trying default camera:', err.name);
                try {
                    const fallbackConstraints = {
                        video: true,
                        audio: false
                    };
                    cameraStream = await mediaDevices.getUserMedia(fallbackConstraints);
                    cameraVideo.srcObject = cameraStream;
                    cameraVideo.style.display = 'block';
                    console.log('Fallback camera started successfully');
                } catch (err2) {
                    console.warn('Camera background completely unavailable:', err2.name, err2.message);
                    cameraVideo.style.display = 'none';
                    // Show user-friendly message instead of console warning
                    showStatus('C√¢mera indispon√≠vel - usando fundo padr√£o', 'info', 3000);
                }
            }
        }
        
        function hideCameraBackground() {
            cameraVideo.style.display = 'none';
        }
        
        function stopCameraBackground() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(t => t.stop());
                cameraStream = null;
            }
            cameraVideo.srcObject = null;
            cameraVideo.style.display = 'none';
        }

        // Stop camera when leaving
        window.addEventListener('beforeunload', stopCameraBackground);
        
        // Initialize
        init();
    </script>
</body>
</html>
